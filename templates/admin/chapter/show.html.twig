{% extends 'admin/layout.html.twig' %}

{% block title %}Détails du Chapitre - EducaVision Admin{% endblock %}

{% block breadcrumb_title %}Détails du Chapitre{% endblock %}

{% block breadcrumb_items %}
    <li><a href="{{ path('admin_chapter_index') }}">Chapitres</a></li>
    <li>Détails</li>
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">{{ chapter.titre }}</h4>
                <div class="card-action">
                    <a href="{{ path('admin_chapter_edit', {'id': chapter.id}) }}" class="btn btn-warning">
                        <i class="fa fa-edit"></i> Modifier
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Image du chapitre -->
                {% if chapter.imageUrl %}
                    <div class="text-center mb-4">
                        <img src="{{ asset('front-assets/images/chapters/' ~ chapter.imageUrl) }}" 
                             alt="{{ chapter.titre }}" 
                             class="img-fluid rounded"
                             style="max-height: 300px; width: auto;"
                             onerror="this.src='{{ asset('assets/images/default-chapter.jpg') }}'">
                    </div>
                {% endif %}

                <!-- Informations principales -->
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informations générales</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>ID:</strong></td>
                                <td>{{ chapter.id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Titre:</strong></td>
                                <td>{{ chapter.titre }}</td>
                            </tr>
                            <tr>
                                <td><strong>Ordre:</strong></td>
                                <td>
                                    {% if chapter.ordre %}
                                        <span class="badge badge-primary">{{ chapter.ordre }}</span>
                                    {% else %}
                                        <span class="text-muted">Non défini</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Créé le:</strong></td>
                                <td>{{ chapter.createdAt|date('d/m/Y H:i') }}</td>
                            </tr>
                        </table>
                    </div>

                    <div class="col-md-6">
                        <h6>Professeur</h6>
                        {% if chapter.teacherName %}
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Nom:</strong></td>
                                    <td>{{ chapter.teacherName }}</td>
                                </tr>
                                {% if chapter.teacherEmail %}
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>
                                        <a href="mailto:{{ chapter.teacherEmail }}" class="text-primary">
                                            {{ chapter.teacherEmail }}
                                        </a>
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        {% else %}
                            <p class="text-muted">Aucun professeur assigné</p>
                        {% endif %}

                        <h6 class="mt-3">Actions rapides</h6>
                        <div class="btn-group-vertical w-100">
                            <a href="{{ path('admin_chapter_edit', {'id': chapter.id}) }}" class="btn btn-warning">
                                <i class="fa fa-edit"></i> Modifier le chapitre
                            </a>
                            {% if chapter.course %}
                                <a href="{{ path('admin_course_show', {'id': chapter.course.id}) }}" class="btn btn-info">
                                    <i class="fa fa-book"></i> Voir le cours
                                </a>
                                <a href="{{ path('front_chapitre_show', {'id': chapter.course.id, 'chapterId': chapter.id}) }}" 
                                   class="btn btn-outline-success" target="_blank">
                                    <i class="fa fa-external-link"></i> Voir sur le site
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Description -->
                {% if chapter.description %}
                    <div class="mt-4">
                        <h6>Contenu du chapitre</h6>
                        <div class="bg-light p-3 rounded">
                            {{ chapter.description|raw }}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Cours associé -->
        {% if chapter.course %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Cours associé</h5>
                </div>
                <div class="card-body">
                    <h6>{{ chapter.course.titre }}</h6>
                    {% if chapter.course.category %}
                        <p><span class="badge badge-info">{{ chapter.course.category }}</span></p>
                    {% endif %}
                    {% if chapter.course.description %}
                        <p class="small text-muted">{{ chapter.course.description|striptags|slice(0, 100) }}...</p>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="{{ path('admin_course_show', {'id': chapter.course.id}) }}" 
                           class="btn btn-sm btn-primary">
                            <i class="fa fa-eye"></i> Voir le cours
                        </a>
                        <a href="{{ path('admin_chapter_by_course', {'courseId': chapter.course.id}) }}" 
                           class="btn btn-sm btn-outline-info">
                            <i class="fa fa-list"></i> Tous les chapitres
                        </a>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Cours associé</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Ce chapitre n'est associé à aucun cours.</p>
                    <a href="{{ path('admin_chapter_edit', {'id': chapter.id}) }}" 
                       class="btn btn-sm btn-primary">
                        <i class="fa fa-link"></i> Associer un cours
                    </a>
                </div>
            </div>
        {% endif %}

        <!-- Messages liés -->
        {% if chapter.course %}
            {% if courseMessages|length > 0 %}
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title">Messages du cours</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">{{ courseMessages|length }} message{{ courseMessages|length > 1 ? 's' : '' }} pour ce cours</p>
                        
                        {% for message in courseMessages|slice(0, 3) %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>{{ message.student }}</strong>
                                    <br><small class="text-muted">{{ message.lastMessageAt|date('d/m/Y') }}</small>
                                    {% if not message.isRead %}
                                        <span class="badge badge-warning ml-2">Non lu</span>
                                    {% endif %}
                                </div>
                                <a href="{{ path('admin_message_show', {'id': message.id}) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fa fa-eye"></i>
                                </a>
                            </div>
                        {% endfor %}
                        
                        {% if courseMessages|length > 3 %}
                            <a href="{{ path('admin_message_by_course', {'courseTitle': chapter.course.titre}) }}" 
                               class="btn btn-sm btn-outline-info w-100">
                                Voir tous les messages ({{ courseMessages|length }})
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p class="text-muted">Aucun message pour ce cours.</p>
            {% endif %}
        {% endif %}

        <!-- Autres chapitres du cours -->
        {% if chapter.course and chapter.course.chapters|length > 1 %}
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title">Autres chapitres du cours</h5>
                </div>
                <div class="card-body">
                    {% for otherChapter in chapter.course.chapters %}
                        {% if otherChapter.id != chapter.id %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="badge badge-primary mr-2">{{ otherChapter.ordre ?: '?' }}</span>
                                    {{ otherChapter.titre }}
                                </div>
                                <a href="{{ path('admin_chapter_show', {'id': otherChapter.id}) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fa fa-eye"></i>
                                </a>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
.badge-success { background-color: #28a745; color: white; }
.badge-danger { background-color: #dc3545; color: white; }
.badge-warning { background-color: #ffc107; color: white; }
.badge-info { background-color: #17a2b8; color: white; }
.badge-primary { background-color: #007bff; color: white; }
.badge-secondary { background-color: #6c757d; color: white; }

.btn-group-vertical .btn {
    margin-bottom: 5px;
}
</style>
{% endblock %}
