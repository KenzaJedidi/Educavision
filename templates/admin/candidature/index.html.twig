{% extends 'admin/layout.html.twig' %}

{% block title %}Candidatures - Admin{% endblock %}

{% block breadcrumb_title %}Offre de Stages{% endblock %}
{% block breadcrumb_items %}
    <li><a href="{{ path('admin_offre_stage_index') }}">Offre de stages</a></li>
    <li>Les Candidatures</li>
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header border-0 p-3 p-md-4 d-flex justify-content-between align-items-center" style="background:linear-gradient(135deg,#fff2cc,#ffc107);">
                <h4 class="mb-0 fw-bold text-dark">Les Candidatures</h4>
                <form method="get" action="{{ path('admin_candidature_index') }}" class="w-auto" style="min-width:280px;">
                    <div class="input-group">
                        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Rechercher (nom, prénom, email, offre, entreprise)" style="border-top-left-radius:20px;border-bottom-left-radius:20px;">
                        <button class="btn btn-warning text-dark" type="submit" style="border-top-right-radius:20px;border-bottom-right-radius:20px;"><i class="fa fa-search"></i> Rechercher</button>
                    </div>
                </form>
            </div>
            <div class="card-body">
                <div class="row mb-3 g-3">
                    <div class="col-md-4">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#6a11cb,#2575fc); color:#fff;">
                            <div class="card-body text-center">
                                <i class="fa fa-users fa-2x mb-2"></i>
                                <h6 class="card-title">Total candidatures</h6>
                                <p class="display-6 fw-bold">{{ total_candidatures }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#2ecc71,#27ae60); color:#fff;">
                            <div class="card-body text-center">
                                <i class="fa fa-check-circle fa-2x mb-2"></i>
                                <h6 class="card-title">Acceptées</h6>
                                <p class="display-6 fw-bold">{{ accepted_candidatures }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#e74c3c,#ff6b6b); color:#fff;">
                            <div class="card-body text-center">
                                <i class="fa fa-times-circle fa-2x mb-2"></i>
                                <h6 class="card-title">Refusées</h6>
                                <p class="display-6 fw-bold">{{ refused_candidatures }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3 align-items-center g-3">
                    <div class="col-auto">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fa fa-chart-pie"></i>
                                    <strong class="small">Répartition des statuts</strong>
                                </div>
                                <div style="width: 220px;">
                                    <canvas id="candidatureStatusChart" style="width:160px;height:160px;" width="160" height="160"></canvas>
                                </div>
                                <div class="mt-2 small text-muted">
                                    {% for item in status_breakdown %}
                                        <span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:{{ item.color }}"></span>
                                        {{ item.label }}: <strong>{{ item.value }}</strong>{% if not loop.last %} • {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fa fa-percent"></i>
                                    <strong class="small">Taux d'acceptation</strong>
                                </div>
                                <div class="progress" style="height: 16px; width: 320px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ acceptance_rate }}%" aria-valuenow="{{ acceptance_rate }}" aria-valuemin="0" aria-valuemax="100">{{ acceptance_rate }}%</div>
                                </div>
                                <small class="text-muted d-block mt-1">{{ accepted_candidatures }} accepté(s) sur {{ total_candidatures }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card border-0 shadow-sm" style="min-width:280px;">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="fa fa-fire"></i>
                                    <strong class="small">Top Offres</strong>
                                </div>
                                {% set offer_colors = [
                                    'linear-gradient(90deg,#ff7eb3,#ff758c)',
                                    'linear-gradient(90deg,#6a11cb,#2575fc)',
                                    'linear-gradient(90deg,#f7971e,#ffd200)'
                                ] %}
                                <div class="small">
                                    {% for t in top_offers %}
                                        {% set p = total_candidatures > 0 ? ((t.count / total_candidatures) * 100) : 0 %}
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-truncate" title="{{ t.title }}">{{ t.title }}</span>
                                                <span class="badge bg-light text-dark">{{ t.count }}</span>
                                            </div>
                                            <div style="height:8px;border-radius:6px;background:#e9ecef;overflow:hidden;">
                                                <div style="height:8px;width: {{ p|round }}%;background: {{ offer_colors[loop.index0] ?? 'linear-gradient(90deg,#43e97b,#38f9d7)' }};"></div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="text-muted">Aucune donnée</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Téléphone</th>
                                <th>Niveau</th>
                                <th>Offre</th>
                                <th>Entreprise</th>
                                <th>Statut</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for c in candidatures %}
                            <tr>
                                <td>{{ c.id }}</td>
                                <td>{{ c.nom }} {{ c.prenom }}</td>
                                <td>{{ c.email }}</td>
                                <td>{{ c.telephone ?? '—' }}</td>
                                <td>{{ c.niveauEtude ?? '—' }}</td>
                                <td>{{ c.offreStage ? c.offreStage.titre : '—' }}</td>
                                <td>{{ c.offreStage ? c.offreStage.entreprise : '—' }}</td>
                                <td>
                                    {% set bg = c.statut == 'En attente' ? '#ffc107' : (c.statut == 'Accepté' ? '#198754' : '#dc3545') %}
                                    {% set color = c.statut == 'En attente' ? '#212529' : '#fff' %}
                                    <span class="badge" style="background-color:{{ bg }};color:{{ color }};border-radius:20px;">{{ c.statut }}</span>
                                </td>
                                <td>{{ c.dateCandidature ? c.dateCandidature|date('d/m/Y H:i') : '—' }}</td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center align-items-center gap-2 flex-nowrap">
                                        <a href="{{ path('admin_candidature_show', { id: c.id }) }}" class="btn text-white shadow-sm p-0" title="Détails" style="width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#0d6efd;border:none;">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                        <form method="post" action="{{ path('admin_candidature_change_status', { id: c.id }) }}" class="m-0" style="display:inline-block;">
                                            <input type="hidden" name="token" value="{{ csrf_token('candidature_status_' ~ c.id) }}">
                                            <button name="status" value="Accepté" class="btn text-white shadow-sm p-0" type="submit" title="Accepter" style="width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#198754;border:none;">
                                                <i class="fa fa-check"></i>
                                            </button>
                                        </form>
                                        <form method="post" action="{{ path('admin_candidature_change_status', { id: c.id }) }}" class="m-0" style="display:inline-block;">
                                            <input type="hidden" name="token" value="{{ csrf_token('candidature_status_' ~ c.id) }}">
                                            <button name="status" value="Refusé" class="btn text-white shadow-sm p-0" type="submit" title="Refuser" style="width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#dc3545;border:none;">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted">Aucune candidature trouvée.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

            {% block javascripts %}
                {{ parent() }}
                <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
                <script>
                    (function() {
                        const ctx = document.getElementById('candidatureStatusChart');
                        if (!ctx) return;
                        const data = {
                            labels: [{% for item in status_breakdown %}'{{ item.label }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                            datasets: [{
                                data: [{% for item in status_breakdown %}{{ item.value }}{% if not loop.last %}, {% endif %}{% endfor %}],
                                backgroundColor: [{% for item in status_breakdown %}'{{ item.color }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                                borderColor: '#ffffff',
                                borderWidth: 2,
                            }]
                        };
                        new Chart(ctx, {
                            type: 'doughnut',
                            data,
                            options: {
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { enabled: true }
                                },
                                cutout: '65%',
                                maintainAspectRatio: false,
                                aspectRatio: 2
                            }
                        });
                    })();
                </script>
            {% endblock %}
