{% extends 'admin/layout.html.twig' %}

{% block title %}Nouvelle Offre de Stage - EducaVision{% endblock %}

{% block breadcrumb_title %}Créer une Offre de Stage{% endblock %}

{% block breadcrumb_items %}
<li><a href="{{ path('admin_offre_stage_index') }}">Offres de Stage</a></li>
<li>Nouvelle Offre</li>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-lg-12 col-md-12">
		<div class="widget-box">
			<div class="wc-title">
				<h4><i class="fa fa-plus-circle"></i> Créer une Nouvelle Offre de Stage</h4>
			</div>
			<div class="widget-inner">
				{{ form_start(form, {'attr': {'novalidate': 'novalidate', 'class': 'form-horizontal'}}) }}

				<!-- Titre -->
				<div class="form-group m-b20">
					<label class="col-lg-3 col-md-4 control-label"><i class="fa fa-briefcase"></i> Titre du Stage</label>
					<div class="col-lg-9 col-md-8">
						{{ form_widget(form.titre, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Développeur Web Junior'}}) }}
						{% if form.titre.vars.errors|length > 0 %}
							<div class="text-danger small mt-1">
								{% for error in form.titre.vars.errors %}
									<i class="fa fa-exclamation-circle"></i> {{ error.message }}
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</div>

				<!-- Description -->
				<div class="form-group m-b20">
					<label class="col-lg-3 col-md-4 control-label"><i class="fa fa-align-left"></i> Description</label>
					<div class="col-lg-9 col-md-8">
						{{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': '6', 'placeholder': 'Décrivez les missions, responsabilités et compétences requises...', 'id': 'offre_description_field'}}) }}
						{% if form.description.vars.errors|length > 0 %}
							<div class="text-danger small mt-1">
								{% for error in form.description.vars.errors %}
									<i class="fa fa-exclamation-circle"></i> {{ error.message }}
								{% endfor %}
							</div>
						{% endif %}
						{# ======== BOUTON GÉNÉRATION IA ======== #}
						<div class="mt-2 d-flex gap-2 align-items-center flex-wrap">
							<button type="button" id="btn-generer-ia" class="btn btn-sm text-white" style="border-radius:20px;background:linear-gradient(135deg,#667eea,#764ba2);" onclick="genererDescriptionIA()">
								<i class="fa fa-robot"></i> Générer avec IA
							</button>
							<input type="text" id="ia-mots-cles" class="form-control form-control-sm" placeholder="Mots-clés (ex: PHP, React, remote)" style="border-radius:20px;max-width:300px;">
							<span id="ia-status" class="small text-muted" style="display:none;"><i class="fa fa-spinner fa-spin"></i> Génération en cours...</span>
						</div>
					</div>
				</div>

				<!-- Entreprise et Lieu -->
				<div class="row">
					<div class="col-lg-6">
						<div class="form-group m-b20">
							<label class="col-lg-5 col-md-4 control-label"><i class="fa fa-building"></i> Entreprise</label>
							<div class="col-lg-12">
								{{ form_widget(form.entreprise, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Acme Corp'}}) }}
								{% if form.entreprise.vars.errors|length > 0 %}
									<div class="text-danger small mt-1">
										{% for error in form.entreprise.vars.errors %}
											<i class="fa fa-exclamation-circle"></i> {{ error.message }}
										{% endfor %}
									</div>
								{% endif %}
							</div>
						</div>
					</div>

					<div class="col-lg-6">
						<div class="form-group m-b20">
							<label class="col-lg-5 col-md-4 control-label"><i class="fa fa-map-marker"></i> Lieu</label>
							<div class="col-lg-12">
								{{ form_widget(form.lieu, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Paris, France'}}) }}
								{% if form.lieu.vars.errors|length > 0 %}
									<div class="text-danger small mt-1">
										{% for error in form.lieu.vars.errors %}
											<i class="fa fa-exclamation-circle"></i> {{ error.message }}
										{% endfor %}
									</div>
								{% endif %}
							</div>
						</div>
					</div>
				</div>

				<!-- Dates -->
				<div class="row">
					<div class="col-lg-6">
						<div class="form-group m-b20">
							<label class="col-lg-5 col-md-4 control-label"><i class="fa fa-calendar"></i> Date de Début</label>
							<div class="col-lg-12">
								{{ form_widget(form.dateDebut, {'attr': {'class': 'form-control'}}) }}
								{% if form.dateDebut.vars.errors|length > 0 %}
									<div class="text-danger small mt-1">
										{% for error in form.dateDebut.vars.errors %}
											<i class="fa fa-exclamation-circle"></i> {{ error.message }}
										{% endfor %}
									</div>
								{% endif %}
							</div>
						</div>
					</div>

					<div class="col-lg-6">
						<div class="form-group m-b20">
							<label class="col-lg-5 col-md-4 control-label"><i class="fa fa-calendar"></i> Date de Fin</label>
							<div class="col-lg-12">
								{{ form_widget(form.dateFin, {'attr': {'class': 'form-control'}}) }}
								{% if form.dateFin.vars.errors|length > 0 %}
									<div class="text-danger small mt-1">
										{% for error in form.dateFin.vars.errors %}
											<i class="fa fa-exclamation-circle"></i> {{ error.message }}
										{% endfor %}
									</div>
								{% endif %}
							</div>
						</div>
					</div>
				</div>

				<!-- Durée et Statut -->
				<div class="row">
					<div class="col-lg-6">
						<div class="form-group m-b20">
							<label class="col-lg-5 col-md-4 control-label"><i class="fa fa-hourglass"></i> Durée (jours)</label>
							<div class="col-lg-12">
								{{ form_widget(form.dureeJours, {'attr': {'class': 'form-control', 'min': '1', 'type': 'number'}}) }}
								{% if form.dureeJours.vars.errors|length > 0 %}
									<div class="text-danger small mt-1">
										{% for error in form.dureeJours.vars.errors %}
											<i class="fa fa-exclamation-circle"></i> {{ error.message }}
										{% endfor %}
									</div>
								{% endif %}
							</div>
						</div>
					</div>

					<div class="col-lg-6">
						<div class="form-group m-b20">
							<label class="col-lg-5 col-md-4 control-label"><i class="fa fa-money"></i> Salaire (DT)</label>
							<div class="col-lg-12">
								{{ form_widget(form.salaire, {'attr': {'class': 'form-control', 'placeholder': 'Ex: 2500'}}) }}
								{% if form.salaire.vars.errors|length > 0 %}
									<div class="text-danger small mt-1">
										{% for error in form.salaire.vars.errors %}
											<i class="fa fa-exclamation-circle"></i> {{ error.message }}
										{% endfor %}
									</div>
								{% endif %}
							</div>
						</div>
					</div>
				</div>

				<!-- Statut -->
				<div class="form-group m-b20">
					<label class="col-lg-3 col-md-4 control-label"><i class="fa fa-tags"></i> Statut</label>
					<div class="col-lg-9 col-md-8">
						{{ form_widget(form.statut, {'attr': {'class': 'form-control'}}) }}
						{% if form.statut.vars.errors|length > 0 %}
							<div class="text-danger small mt-1">
								{% for error in form.statut.vars.errors %}
									<i class="fa fa-exclamation-circle"></i> {{ error.message }}
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</div>

					<!-- Boutons d'action -->
				<div class="form-group m-t30">
					<div class="col-lg-offset-3 col-lg-9 col-md-offset-4 col-md-8">
						<button type="submit" class="btn btn-lg btn-action-create">
							<i class="fa fa-save"></i> Créer l'offre
						</button>
						<a href="{{ path('admin_offre_stage_index') }}" class="btn btn-lg btn-action-back">
							<i class="fa fa-arrow-left"></i> Retour
						</a>
					</div>
				</div>

				{{ form_end(form) }}
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
function genererDescriptionIA() {
	const titreField = document.querySelector('[name*="[titre]"]');
	const entrepriseField = document.querySelector('[name*="[entreprise]"]');
	const lieuField = document.querySelector('[name*="[lieu]"]');
	const descField = document.getElementById('offre_description_field') || document.querySelector('[name*="[description]"]');
	const motsClesField = document.getElementById('ia-mots-cles');
	const statusEl = document.getElementById('ia-status');
	const btn = document.getElementById('btn-generer-ia');

	const titre = titreField ? titreField.value.trim() : '';
	const entreprise = entrepriseField ? entrepriseField.value.trim() : '';
	const lieu = lieuField ? lieuField.value.trim() : '';
	const motsCles = motsClesField ? motsClesField.value.trim() : '';

	if (!titre) {
		alert('Veuillez d\'abord remplir le titre du stage.');
		return;
	}

	btn.disabled = true;
	statusEl.style.display = 'inline';

	fetch('{{ path("admin_offre_stage_generer_description") }}', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
		body: JSON.stringify({ titre, entreprise, mots_cles: motsCles, lieu })
	})
	.then(r => r.json())
	.then(data => {
		if (data.description) {
			descField.value = data.description;
			descField.style.borderColor = '#667eea';
			setTimeout(() => descField.style.borderColor = '', 2000);
		} else {
			alert(data.error || 'Erreur lors de la génération.');
		}
	})
	.catch(err => {
		alert('Erreur réseau : ' + err.message);
	})
	.finally(() => {
		btn.disabled = false;
		statusEl.style.display = 'none';
	});
}
</script>
{% endblock %}
