{% extends 'admin/layout.html.twig' %}

{% block title %}Candidatures - Admin{% endblock %}

{% block breadcrumb_title %}Offre de Stages{% endblock %}
{% block breadcrumb_items %}
    <li><a href="{{ path('admin_offre_stage_index') }}">Offre de stages</a></li>
    <li>Les Candidatures</li>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .ai-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .score-bar { height: 6px; border-radius: 3px; background: #e9ecef; overflow: hidden; width: 80px; display: inline-block; vertical-align: middle; }
    .score-fill { height: 100%; border-radius: 3px; }
    .favori-btn { cursor: pointer; font-size: 18px; border: none; background: none; padding: 0; }
    .filter-bar { background: rgba(255,255,255,0.7); border-radius: 12px; padding: 8px 12px; }
</style>
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header border-0 p-3 p-md-4 d-flex justify-content-between align-items-center flex-wrap gap-2" style="background:linear-gradient(135deg,#fff2cc,#ffc107);">
                <h4 class="mb-0 fw-bold text-dark">Les Candidatures <span class="ai-badge"><i class="fa fa-robot"></i> IA Intégrée</span></h4>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <a href="{{ path('admin_candidature_export_stats_pdf') }}" class="btn btn-sm btn-danger" style="border-radius: 20px;">
                        <i class="fa fa-file-pdf-o"></i> Export PDF
                    </a>
                </div>
            </div>
            <div class="card-body">
                {# ======== FILTRES AVANCÉS ======== #}
                <form method="get" action="{{ path('admin_candidature_index') }}" class="filter-bar mb-3">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Rechercher (nom, email, offre, entreprise)" style="border-radius:20px 0 0 20px;">
                                <button class="btn btn-warning text-dark" type="submit" style="border-radius:0 20px 20px 0;"><i class="fa fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select name="statut" class="form-select form-select-sm" style="border-radius:20px;" onchange="this.form.submit()">
                                <option value="">Tous statuts</option>
                                <option value="En attente" {{ filter_statut == 'En attente' ? 'selected' : '' }}>⏳ En attente</option>
                                <option value="Accepté" {{ filter_statut == 'Accepté' ? 'selected' : '' }}>✅ Accepté</option>
                                <option value="Refusé" {{ filter_statut == 'Refusé' ? 'selected' : '' }}>❌ Refusé</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select name="favori" class="form-select form-select-sm" style="border-radius:20px;" onchange="this.form.submit()">
                                <option value="">Tous candidats</option>
                                <option value="1" {{ filter_favori == '1' ? 'selected' : '' }}>⭐ Favoris uniquement</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">{{ pagination.getTotalItemCount }} résultat(s)</small>
                        </div>
                    </div>
                </form>

                {# ======== STATISTIQUES DASHBOARD ======== #}
                <div class="row mb-2 g-2">
                    <div class="col-6 col-md">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#6a11cb,#2575fc); color:#fff;">
                            <div class="card-body text-center py-2 px-2">
                                <i class="fa fa-users mb-1" style="font-size:16px"></i>
                                <h6 class="card-title mb-0" style="font-size:10px">Total</h6>
                                <p class="fw-bold mb-0" style="font-size:20px">{{ total_candidatures }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#2ecc71,#27ae60); color:#fff;">
                            <div class="card-body text-center py-2 px-2">
                                <i class="fa fa-check-circle mb-1" style="font-size:16px"></i>
                                <h6 class="card-title mb-0" style="font-size:10px">Acceptées</h6>
                                <p class="fw-bold mb-0" style="font-size:20px">{{ accepted_candidatures }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#f1c40f,#f39c12); color:#333;">
                            <div class="card-body text-center py-2 px-2">
                                <i class="fa fa-hourglass-half mb-1" style="font-size:16px"></i>
                                <h6 class="card-title mb-0" style="font-size:10px">En attente</h6>
                                <p class="fw-bold mb-0" style="font-size:20px">{{ pending_candidatures }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#e74c3c,#ff6b6b); color:#fff;">
                            <div class="card-body text-center py-2 px-2">
                                <i class="fa fa-times-circle mb-1" style="font-size:16px"></i>
                                <h6 class="card-title mb-0" style="font-size:10px">Refusées</h6>
                                <p class="fw-bold mb-0" style="font-size:20px">{{ refused_candidatures }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md">
                        <div class="card border-0 shadow h-100" style="background: linear-gradient(135deg, #667eea, #764ba2); color:#fff;">
                            <div class="card-body text-center py-2 px-2">
                                <i class="fa fa-robot mb-1" style="font-size:16px"></i>
                                <h6 class="card-title mb-0" style="font-size:10px">Score IA Moy.</h6>
                                <p class="fw-bold mb-0" style="font-size:20px">{{ score_moyen_ia ?? '—' }}{% if score_moyen_ia is not null %}<small>/100</small>{% endif %}</p>
                            </div>
                        </div>
                    </div>
                </div>

                {# ======== GRAPHIQUES CHART.JS ======== #}
                <div class="row mb-2 g-2">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fa fa-chart-pie" style="font-size:12px"></i>
                                    <strong style="font-size:11px">Répartition des statuts</strong>
                                </div>
                                <div class="mx-auto" style="max-width:120px;height:120px;">
                                    <canvas id="candidatureStatusChart" width="120" height="120"></canvas>
                                </div>
                                <div class="mt-2 small text-muted text-center">
                                    {% for item in status_breakdown %}
                                        <span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:{{ item.color }}"></span>
                                        {{ item.label }}: <strong>{{ item.value }}</strong>{% if not loop.last %} • {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fa fa-chart-line" style="font-size:12px"></i>
                                    <strong style="font-size:11px">Candidatures par mois</strong>
                                </div>
                                <div style="position:relative;height:100px;">
                                    <canvas id="candidaturesParMoisChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fa fa-percent" style="font-size:12px"></i>
                                    <strong style="font-size:11px">Taux d'acceptation</strong>
                                </div>
                                <div class="progress mb-1" style="height: 12px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ acceptance_rate }}%">{{ acceptance_rate }}%</div>
                                </div>
                                <small class="text-muted">{{ accepted_candidatures }} accepté(s) sur {{ total_candidatures }}</small>

                                <hr>
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="fa fa-fire"></i>
                                    <strong class="small">Top Offres</strong>
                                </div>
                                {% for t in top_offers %}
                                    {% set p = total_candidatures > 0 ? ((t.count / total_candidatures) * 100) : 0 %}
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between small">
                                            <span class="text-truncate" title="{{ t.title }}">{{ t.title|length > 22 ? t.title[:22] ~ '…' : t.title }}</span>
                                            <span class="badge bg-light text-dark ms-1">{{ t.count }}</span>
                                        </div>
                                        <div style="height:6px;border-radius:3px;background:#e9ecef;overflow:hidden;">
                                            <div style="height:6px;width:{{ p|round }}%;background:linear-gradient(90deg,#667eea,#764ba2);"></div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-muted small">Aucune donnée</div>
                                {% endfor %}

                                <hr>
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fa fa-star text-warning"></i>
                                    <strong class="small">Favoris: {{ favoris_count }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {# ======== TABLEAU DES CANDIDATURES ======== #}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width:35px"><i class="fa fa-star text-warning"></i></th>
                                <th>#</th>
                                <th>Nom & Prénom</th>
                                <th>Email</th>
                                <th>Niveau</th>
                                <th>Offre</th>
                                <th><i class="fa fa-robot"></i> Score IA</th>
                                <th>Note</th>
                                <th>Statut</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for c in pagination %}
                            <tr>
                                <td>
                                    <form method="post" action="{{ path('admin_candidature_toggle_favori', {id: c.id}) }}" style="display:inline">
                                        <button type="submit" class="favori-btn" title="{{ c.favori ? 'Retirer des favoris' : 'Ajouter aux favoris' }}">
                                            {{ c.favori ? '⭐' : '☆' }}
                                        </button>
                                    </form>
                                </td>
                                <td>{{ c.id }}</td>
                                <td>
                                    <strong>{{ c.nom }} {{ c.prenom }}</strong>
                                    {% if c.competencesDetectees is not null and c.competencesDetectees is iterable and c.competencesDetectees|length > 0 %}
                                        <br><small class="text-muted"><i class="fa fa-tags"></i> 
                                        {% for comp in c.competencesDetectees|slice(0,3) %}{{ comp is iterable ? comp|join('/') : comp }}{% if not loop.last %}, {% endif %}{% endfor %}
                                        </small>
                                    {% endif %}
                                </td>
                                <td>{{ c.email }}</td>
                                <td>{{ c.niveauEtude ?? '—' }}</td>
                                <td>{{ c.offreStage ? c.offreStage.titre : '—' }}</td>
                                <td>
                                    {% if c.scoreIa is not null %}
                                        <span class="ai-badge">{{ c.scoreIa }}/100</span>
                                        <div class="score-bar mt-1">
                                            <div class="score-fill" style="width:{{ c.scoreIa }}%;background:{% if c.scoreIa >= 70 %}#2ecc71{% elseif c.scoreIa >= 40 %}#f1c40f{% else %}#e74c3c{% endif %};"></div>
                                        </div>
                                    {% else %}
                                        <span class="text-muted small">Non analysé</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if c.noteAdmin %}
                                        {% for i in 1..5 %}
                                            <span style="color:{% if i <= c.noteAdmin %}#f1c40f{% else %}#ccc{% endif %};font-size:12px;">★</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted small">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set bg = c.statut == 'En attente' ? '#ffc107' : (c.statut == 'Accepté' ? '#198754' : '#dc3545') %}
                                    {% set color = c.statut == 'En attente' ? '#212529' : '#fff' %}
                                    <span class="badge" style="background-color:{{ bg }};color:{{ color }};border-radius:20px;">{{ c.statut }}</span>
                                </td>
                                <td>{{ c.dateCandidature ? c.dateCandidature|date('d/m/Y') : '—' }}</td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center align-items-center gap-1 flex-nowrap">
                                        <a href="{{ path('admin_candidature_show', { id: c.id }) }}" class="btn text-white shadow-sm p-0" title="Détails + IA" style="width:34px;height:34px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;background:#0d6efd;border:none;">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                        <form method="post" action="{{ path('admin_candidature_change_status', { id: c.id }) }}" class="m-0" style="display:inline-block;">
                                            <input type="hidden" name="token" value="{{ csrf_token('candidature_status_' ~ c.id) }}">
                                            <button name="status" value="Accepté" class="btn text-white shadow-sm p-0" type="submit" title="Accepter" style="width:34px;height:34px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;background:#198754;border:none;">
                                                <i class="fa fa-check"></i>
                                            </button>
                                        </form>
                                        <form method="post" action="{{ path('admin_candidature_change_status', { id: c.id }) }}" class="m-0" style="display:inline-block;">
                                            <input type="hidden" name="token" value="{{ csrf_token('candidature_status_' ~ c.id) }}">
                                            <button name="status" value="Refusé" class="btn text-white shadow-sm p-0" type="submit" title="Refuser" style="width:34px;height:34px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;background:#dc3545;border:none;">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="11" class="text-center text-muted py-4">
                                    <i class="fa fa-inbox fa-2x mb-2 d-block"></i>
                                    Aucune candidature trouvée.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                {# ======== PAGINATION KnpPaginator ======== #}
                {% if pagination.getTotalItemCount > 0 %}
                <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
                    <small class="text-muted">
                        Page {{ pagination.getCurrentPageNumber }} / {{ (pagination.getTotalItemCount / pagination.getItemNumberPerPage)|round(0, 'ceil') }}
                        — {{ pagination.getTotalItemCount }} résultat(s)
                    </small>
                    <nav>
                        {{ knp_pagination_render(pagination) }}
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        (function() {
            // Doughnut - Répartition statuts
            const ctx = document.getElementById('candidatureStatusChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [{% for item in status_breakdown %}'{{ item.label }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        datasets: [{
                            data: [{% for item in status_breakdown %}{{ item.value }}{% if not loop.last %}, {% endif %}{% endfor %}],
                            backgroundColor: [{% for item in status_breakdown %}'{{ item.color }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false }, tooltip: { enabled: true } },
                        cutout: '65%',
                        maintainAspectRatio: false,
                    }
                });
            }

            // Line - Candidatures par mois
            const moisCtx = document.getElementById('candidaturesParMoisChart');
            if (moisCtx) {
                new Chart(moisCtx, {
                    type: 'line',
                    data: {
                        labels: [{% for mois, count in candidatures_par_mois %}'{{ mois }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        datasets: [{
                            label: 'Candidatures',
                            data: [{% for mois, count in candidatures_par_mois %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.15)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#667eea',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    }
                });
            }
        })();
    </script>
{% endblock %}
