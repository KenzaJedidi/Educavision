{% extends 'front/base.html.twig' %}

{% block title %}R√©clamation - EducaVision{% endblock %}

{% block body %}
<div class="page-banner ovbl-dark" style="background-image:url({{ asset('front-assets/images/banner/stages-banner.jpg') }});">
    <div class="container">
        <div class="page-banner-entry">
            <h1 class="text-white">R√©clamation</h1>
        </div>
    </div>
    <div class="breadcrumb-row">
        <div class="container">
            <ul class="list-inline">
                <li><a href="{{ path('front_home') }}">Accueil</a></li>
                <li>R√©clamation</li>
            </ul>
        </div>
    </div>
</div>

{% form_theme form 'bootstrap_5_layout.html.twig' %}

<div class="content-block">
    <div class="section-area section-sp2" style="background:linear-gradient(135deg,#f8f9fa 0%, #e8f1ff 100%);">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-9">
                    <div class="card border-0 shadow-lg overflow-hidden">
                        <div class="p-4 p-md-5" style="background:linear-gradient(135deg,#0dcaf0,#0b7ea1);">
                            <div class="d-flex flex-wrap justify-content-between align-items-center text-white">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="display-6"><i class="fa fa-exclamation-circle"></i></div>
                                    <div>
                                        <h2 class="h4 fw-bold mb-1">D√©poser une r√©clamation</h2>
                                        <p class="mb-0 opacity-75">Expliquez votre probl√®me pour que nous puissions vous aider rapidement.</p>
                                    </div>
                                </div>
                                <a href="{{ path('front_reclamation_my') }}" class="btn btn-light text-dark"><i class="fa fa-user"></i> Mes r√©clamations</a>
                            </div>
                        </div>
                        <div class="p-4 p-md-5 bg-white">
                            {% if form is defined and form.vars.errors|length > 0 %}
                                <div class="alert alert-danger mb-4">
                                    <div class="fw-bold mb-2"><i class="fa fa-exclamation-triangle"></i> Veuillez corriger les erreurs suivantes :</div>
                                    {{ form_errors(form) }}
                                </div>
                            {% endif %}

                            {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        {{ form_widget(form.nom, {'attr': {'class': 'form-control', 'placeholder':'Votre nom'}}) }}
                                        {{ form_label(form.nom, 'Nom') }}
                                        {{ form_errors(form.nom) }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        {{ form_widget(form.prenom, {'attr': {'class': 'form-control', 'placeholder':'Votre pr√©nom'}}) }}
                                        {{ form_label(form.prenom, 'Pr√©nom') }}
                                        {{ form_errors(form.prenom) }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        {{ form_widget(form.email, {'attr': {'class': 'form-control', 'placeholder':'Votre email'}}) }}
                                        {{ form_label(form.email, 'Email') }}
                                        {{ form_errors(form.email) }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        {{ form_widget(form.role, {'attr': {'class': 'form-select', 'placeholder':'Votre r√¥le'}}) }}
                                        {{ form_label(form.role, 'R√¥le') }}
                                        {{ form_errors(form.role) }}
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        {{ form_widget(form.titre, {'attr': {'class': 'form-control', 'placeholder':'Sujet de la r√©clamation'}}) }}
                                        {{ form_label(form.titre, 'Sujet') }}
                                        {{ form_errors(form.titre) }}
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                            {{ form_widget(form.description, {'attr': {'class': 'form-control', 'style': 'min-height:150px', 'placeholder':'D√©crivez votre r√©clamation en d√©tail', 'id':'rec_description'}}) }}
                                            {{ form_label(form.description, 'Description d√©taill√©e') }}
                                            {{ form_errors(form.description) }}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 d-flex justify-content-between align-items-center">
                                <a href="{{ path('front_home') }}" class="btn btn-outline-secondary"><i class="fa fa-arrow-left"></i> Annuler</a>
                                <button type="submit" class="btn btn-primary px-4"><i class="fa fa-paper-plane"></i> Envoyer</button>
                            </div>
                            {{ form_end(form) }}
                            <div id="analysis_preview" class="mt-4 p-3" style="display:none; border-radius:8px; background:linear-gradient(90deg,#f6f9ff,#eef6ff); box-shadow:0 6px 18px rgba(13,202,240,0.08);">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 id="ap_summary_title">R√©sum√© automatique</h5>
                                        <p id="ap_summary" class="mb-2 text-muted"></p>
                                        <div id="ap_sentiment" class="mb-2"></div>
                                        <div id="ap_prediction" class="small text-muted"></div>
                                    </div>
                                    <div style="min-width:120px; text-align:right;">
                                        <div id="ap_clock" style="font-size:18px; font-weight:600; color:#0b7ea1"></div>
                                        <div class="mt-2">
                                            <div class="progress" style="height:8px; background:rgba(11,126,161,0.12)">
                                                <div id="ap_progress" class="progress-bar" role="progressbar" style="width:0%; background:#0dcaf0"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function(){
            const textarea = document.getElementById('rec_description');
            if (!textarea) return;
            let timeout = null;
            const preview = document.getElementById('analysis_preview');
            const sumEl = document.getElementById('ap_summary');
            const sentEl = document.getElementById('ap_sentiment');
            const predEl = document.getElementById('ap_prediction');
            const clockEl = document.getElementById('ap_clock');
            const progEl = document.getElementById('ap_progress');

            function render(data){
                if(!data) { preview.style.display='none'; return; }
                preview.style.display='block';
                sumEl.textContent = data.summary || '(aucun)';
                const s = data.sentiment || 'neutre';
                const score = data.sentimentScore ?? 0;
                const conf = data.sentimentConfidence ?? 0;
                let color = '#6c757d'; let emoji='üòê';
                if (s === 'positif'){ color = '#2ecc71'; emoji='üòä'; }
                if (s === 'n√©gatif'){ color = '#e74c3c'; emoji='üòü'; }
                sentEl.innerHTML = '<strong>Sentiment</strong>: <span style="color:'+color+'">'+emoji+' '+(s.charAt(0).toUpperCase()+s.slice(1))+'</span> <small class="text-muted">(score:'+score+', conf:'+conf+')</small>';
                predEl.textContent = 'Temps de r√©solution estim√© : ' + (data.predictedHours ?? '?') + 'h';
                clockEl.textContent = (data.predictedHours ?? '?') + 'h';
                // progress based on hours within 0-168
                const pct = Math.min(100, Math.round((data.predictedHours/168)*100));
                progEl.style.width = pct + '%';
            }

            async function analyze(text){
                try{
                    const res = await fetch('{{ path('api_reclamation_analyze') }}', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({text})
                    });
                    if (!res.ok) { render(null); return; }
                    const data = await res.json();
                    render(data);
                }catch(e){ console.error(e); render(null); }
            }

            textarea.addEventListener('input', function(){
                clearTimeout(timeout);
                const v = this.value || '';
                if (v.trim().length < 20) { preview.style.display='none'; return; }
                timeout = setTimeout(()=> analyze(v), 600);
            });
        })();
    </script>
{% endblock %}
