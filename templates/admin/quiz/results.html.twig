{% extends 'admin/layout.html.twig' %}

{% block title %}Résultats des Quiz - EducaVision{% endblock %}

{% block breadcrumb_title %}Quizs et Résultats{% endblock %}

{% block breadcrumb_items %}
<li><a href="{{ path('admin_dashboard') }}">Dashboard</a></li>
<li><a href="{{ path('admin_quiz_index') }}">Quizs et Résultats</a></li>
<li>Résultats</li>
{% endblock %}

{% block body %}
<div class="mb-3 d-flex justify-content-between align-items-center">
	<h2 class="h5 mb-0">Résultats des Quiz</h2>
	<div>
		<a href="{{ path('admin_quiz_index') }}" class="btn btn-outline-primary me-2">
			<i class="fa fa-arrow-left"></i> Retour aux Quiz
		</a>
		<a href="{{ path('admin_quiz_new') }}" class="btn btn-primary">
			<i class="fa fa-plus"></i> Créer un Quiz
		</a>
	</div>
</div>

<!-- Statistiques globales -->
<div class="row m-b30">
	<div class="col-md-3">
		<div class="widget-card widget-bg2">
			<div class="wc-item">
				<h4 class="wc-title">Total Résultats</h4>
				<span class="wc-des">Tous les quiz</span>
				<span class="wc-stats counter">{{ results|length }}</span>
				<div class="progress wc-progress">
					<div class="progress-bar" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
				</div>
				<span class="wc-progress-bx">
					<span class="wc-change">Complet</span>
					<span class="wc-number ml-auto">100%</span>
				</span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="widget-card widget-bg3">
			<div class="wc-item">
				<h4 class="wc-title">Score Moyen</h4>
				<span class="wc-des">Performance globale</span>
				{% set totalScore = 0 %}
				{% set totalQuestions = 0 %}
				{% for result in results %}
					{% set totalScore = totalScore + result.score %}
					{% set totalQuestions = totalQuestions + result.quiz.questions.count %}
				{% endfor %}
				{% set avgScore = totalQuestions > 0 ? (totalScore / totalQuestions)|round(1) : 0 %}
				<span class="wc-stats">{{ avgScore }}</span>
				<div class="progress wc-progress">
					<div class="progress-bar" role="progressbar" style="width: {{ (avgScore * 10) }}%;" aria-valuenow="{{ avgScore * 10 }}" aria-valuemin="0" aria-valuemax="100"></div>
				</div>
				<span class="wc-progress-bx">
					<span class="wc-change">Moyenne</span>
					<span class="wc-number ml-auto">{{ (avgScore * 10)|round }}%</span>
				</span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="widget-card widget-bg4">
			<div class="wc-item">
				<h4 class="wc-title">Participants</h4>
				<span class="wc-des">Étudiants uniques</span>
				{% set uniqueUsers = [] %}
				{% for result in results %}
					{% set uniqueUsers = uniqueUsers|merge([result.utilisateur]) %}
				{% endfor %}
				<span class="wc-stats">{{ uniqueUsers|length }}</span>
				<div class="progress wc-progress">
					<div class="progress-bar" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
				</div>
				<span class="wc-progress-bx">
					<span class="wc-change">Uniques</span>
					<span class="wc-number ml-auto">100%</span>
				</span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="widget-card widget-bg1">
			<div class="wc-item">
				<h4 class="wc-title">Quiz Actifs</h4>
				<span class="wc-des">Avec résultats</span>
				{% set activeQuizzes = [] %}
				{% for result in results %}
					{% set activeQuizzes = activeQuizzes|merge([result.quiz.idquiz]) %}
				{% endfor %}
				<span class="wc-stats">{{ activeQuizzes|length }}</span>
				<div class="progress wc-progress">
					<div class="progress-bar" role="progressbar" style="width: {{ (activeQuizzes|length / (activeQuizzes|length + 1)) * 100 }}%;" aria-valuenow="{{ (activeQuizzes|length / (activeQuizzes|length + 1)) * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
				</div>
				<span class="wc-progress-bx">
					<span class="wc-change">Actifs</span>
					<span class="wc-number ml-auto">{{ (activeQuizzes|length / (activeQuizzes|length + 1)) * 100|round }}%</span>
				</span>
			</div>
		</div>
	</div>
</div>

<!-- Tableau des résultats -->
<div class="row">
	<div class="col-lg-12 m-b30">
		<div class="widget-box">
			<div class="wc-title">
				<h4>Liste des Résultats</h4>
			</div>
			<div class="widget-inner">
				{% if results is not empty %}
					<div class="table-responsive">
						<table class="table table-hover">
							<thead>
								<tr>
									<th>Quiz</th>
									<th>Utilisateur</th>
									<th>Score</th>
									<th>Pourcentage</th>
									<th>Date</th>
									<th>Performance</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for result in results %}
									{% set quiz = result.quiz %}
									{% set totalQuestions = quiz.questions.count %}
									{% set percentage = totalQuestions > 0 ? ((result.score / totalQuestions) * 100)|round(1) : 0 %}
									{% set performance = percentage >= 80 ? 'Excellent' : (percentage >= 60 ? 'Bon' : 'À améliorer') %}
									{% set performanceClass = percentage >= 80 ? 'success' : (percentage >= 60 ? 'warning' : 'danger') %}
									
									<tr>
										<td>
											<strong>{{ quiz.titre }}</strong>
											<br>
											<small class="text-muted">{{ quiz.description|slice(0, 50) ~ '...' }}</small>
										</td>
										<td>
											<span class="badge bg-secondary">{{ result.utilisateur }}</span>
										</td>
										<td>
											<span class="badge bg-{{ performanceClass }}">{{ result.score }}/{{ totalQuestions }}</span>
										</td>
										<td>
											<div class="d-flex align-items-center">
												<div class="progress me-2" style="width: 60px; height: 8px;">
													<div class="progress-bar bg-{{ performanceClass }}" role="progressbar" style="width: {{ percentage }}%;" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
												</div>
												<small>{{ percentage }}%</small>
											</div>
										</td>
										<td>
											{{ result.datepassage|date('d/m/Y H:i') }}
										</td>
										<td>
											<span class="badge bg-{{ performanceClass }}">{{ performance }}</span>
										</td>
										<td>
											<div class="btn-group" role="group">
												<a href="{{ path('quiz_results_detail', {'id': result.idresult}) }}" class="btn btn-sm btn-info" title="Voir les détails">
													<i class="fa fa-eye"></i>
												</a>
												<a href="{{ path('admin_quiz_show', {'idquiz': quiz.idquiz}) }}" class="btn btn-sm btn-primary" title="Voir le quiz">
													<i class="fa fa-question-circle"></i>
												</a>
												<a href="{{ path('admin_quiz_export_csv', {'idquiz': quiz.idquiz}) }}" class="btn btn-sm btn-success" title="Exporter CSV">
													<i class="fa fa-file-csv"></i>
												</a>
												<a href="{{ path('admin_quiz_export_word', {'idquiz': quiz.idquiz}) }}" class="btn btn-sm btn-secondary" title="Exporter Word">
													<i class="fa fa-file-word"></i>
												</a>
											</div>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					
					<!-- Pagination -->
					<div class="row mt-3">
						<div class="col-md-6">
							<div class="d-flex align-items-center">
								<span class="text-muted">
									<i class="fa fa-info-circle"></i>
									Affichage de {{ results|length }} résultats
								</span>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex justify-content-end">
								<a href="{{ path('admin_quiz_statistics') }}" class="btn btn-outline-primary me-2">
									<i class="fa fa-chart-bar"></i> Statistiques détaillées
								</a>
								<a href="{{ path('admin_quiz_export_csv', {'idquiz': results[0].quiz.idquiz}) }}" class="btn btn-outline-success">
									<i class="fa fa-download"></i> Exporter tout
								</a>
							</div>
						</div>
					</div>
				{% else %}
					<div class="alert alert-info text-center">
						<i class="fa fa-info-circle fa-2x mb-3"></i>
						<h5>Aucun résultat de quiz disponible</h5>
						<p class="mb-0">Les résultats apparaîtront ici dès que les étudiants commenceront à passer les quiz.</p>
						<div class="mt-3">
							<a href="{{ path('admin_quiz_new') }}" class="btn btn-primary">
								<i class="fa fa-plus"></i> Créer un quiz
							</a>
							<a href="{{ path('quiz_index') }}" class="btn btn-outline-secondary ms-2" target="_blank">
								<i class="fa fa-eye"></i> Voir les quiz publics
							</a>
						</div>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- Filtres et recherche -->
<div class="row">
	<div class="col-lg-12 m-b30">
		<div class="widget-box">
			<div class="wc-title">
				<h4>Filtres et Recherche</h4>
			</div>
			<div class="widget-inner">
				<form method="get" class="row g-3">
					<div class="col-md-4">
						<label for="search" class="form-label">Rechercher</label>
						<input type="text" class="form-control" id="search" name="search" 
							   placeholder="Quiz, utilisateur..." value="{{ search }}">
					</div>
					<div class="col-md-3">
						<label for="quiz" class="form-label">Quiz</label>
						<select class="form-control" id="quiz" name="quiz">
							<option value="">Tous les quiz</option>
							{% set uniqueQuizzes = [] %}
							{% for result in results %}
								{% if result.quiz.idquiz not in uniqueQuizzes %}
									{% set uniqueQuizzes = uniqueQuizzes|merge([result.quiz.idquiz]) %}
									<option value="{{ result.quiz.idquiz }}" 
											{% if quizId == result.quiz.idquiz %}selected{% endif %}>
										{{ result.quiz.titre }}
									</option>
								{% endif %}
							{% endfor %}
						</select>
					</div>
					<div class="col-md-3">
						<label for="performance" class="form-label">Performance</label>
						<select class="form-control" id="performance" name="performance">
							<option value="">Toutes</option>
							<option value="excellent" {% if performance == 'excellent' %}selected{% endif %}>Excellent (≥80%)</option>
							<option value="bon" {% if performance == 'bon' %}selected{% endif %}>Bon (60-79%)</option>
							<option value="ameliorer" {% if performance == 'ameliorer' %}selected{% endif %}>À améliorer (<60%)</option>
						</select>
					</div>
					<div class="col-md-2">
						<label class="form-label">&nbsp;</label>
						<div class="d-flex gap-2">
							<button type="submit" class="btn btn-primary">
								<i class="fa fa-search"></i> Filtrer
							</button>
							<a href="{{ path('admin_quiz_results') }}" class="btn btn-outline-secondary">
								<i class="fa fa-times"></i>
							</a>
						</div>
					</div>
				</form>
				
				{% if search or quizId or performance %}
				<div class="mt-3">
					<div class="alert alert-info">
						<i class="fa fa-info-circle"></i>
						<strong>Filtres actifs:</strong>
						{% if search %} Recherche: "{{ search }}"{% endif %}
						{% if quizId %}
							{% set foundQuiz = false %}
							{% for result in results %}
								{% if result.quiz.idquiz == quizId and not foundQuiz %}
									Quiz: "{{ result.quiz.titre }}"
									{% set foundQuiz = true %}
								{% endif %}
							{% endfor %}
						{% endif %}
						{% if performance %}
							Performance: 
							{% if performance == 'excellent' %}Excellent (≥80%){% endif %}
							{% if performance == 'bon' %}Bon (60-79%){% endif %}
							{% if performance == 'ameliorer' %}À améliorer (<60%){% endif %}
						{% endif %}
						<span class="badge bg-primary">{{ results|length }} résultat(s)</span>
					</div>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<style>
.badge {
	font-size: 0.875em;
}

.progress {
	background-color: #e9ecef;
}

.table th {
	background-color: #f8f9fa;
	border-top: none;
}

.btn-group .btn {
	padding: 0.25rem 0.5rem;
	font-size: 0.875rem;
}

.widget-card {
	transition: transform 0.2s ease;
}

.widget-card:hover {
	transform: translateY(-2px);
}

.alert {
	border-radius: 10px;
}
</style>
{% endblock %}
