
{% extends 'admin/layout.html.twig' %}
{% block breadcrumb_title %}R√©clamation{% endblock %}
{% block breadcrumb_items %}
    <li><a href="{{ path('admin_dashboard') }}">Dashboard</a></li>
    <li>R√©clamation</li>
{% endblock %}
{% block body %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-primary"><i class="fa fa-comments"></i> Liste des R√©clamations</h1>
    <div>
        <a href="{{ path('reclamation_export_pdf', {search: search}) }}" class="btn text-white" style="background:#dc3545;border-color:#dc3545;">
            <i class="fa fa-file-pdf-o"></i> Exporter en PDF
        </a>
        <button id="analyzeAllBtn" class="btn btn-primary ms-2" data-csrf="{{ csrf_token('analyze_all') }}">
            <i class="fa fa-magic"></i> Analyser tout
        </button>
    </div>
</div>
<form method="get" class="mb-4 d-flex flex-wrap gap-2 align-items-center bg-light p-3 rounded shadow-sm" action="">
    <input type="text" name="search" class="form-control me-2 flex-grow-1" placeholder="Recherche par nom, pr√©nom, email ou titre..." value="{{ search|default('') }}">
    <button class="btn btn-outline-primary" type="submit"><i class="fa fa-search"></i> Rechercher</button>
    {% if search %}
        <a href="{{ path('reclamation_index') }}" class="btn btn-link ms-2">R√©initialiser</a>
    {% endif %}
</form>
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#2ec4b6,#20bfa9); color:#fff;">
            <div class="card-body text-center">
                <i class="fa fa-list fa-2x mb-2"></i>
                <h5 class="card-title">Total</h5>
                <p class="display-6 fw-bold">{{ total_reclamations }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#43e97b,#38f9d7); color:#fff;">
            <div class="card-body text-center">
                <i class="fa fa-check-circle fa-2x mb-2"></i>
                <h5 class="card-title">Trait√©es</h5>
                <p class="display-6 fw-bold">{{ traite_reclamations }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow h-100" style="background: linear-gradient(90deg,#f7971e,#ffd200); color:#fff;">
            <div class="card-body text-center">
                <i class="fa fa-hourglass-half fa-2x mb-2"></i>
                <h5 class="card-title">En cours</h5>
                <p class="display-6 fw-bold">{{ encours_reclamations }}</p>
            </div>
        </div>
    </div>
</div>
<div class="table-responsive mt-4">
    {# Sentiment summary cards above the table #}
    {% set senti_pos = 0 %}
    {% set senti_neutre = 0 %}
    {% set senti_neg = 0 %}
    {% for r in reclamations %}
        {% if r.sentimentAuto == 'positif' %}
            {% set senti_pos = senti_pos + 1 %}
        {% elseif r.sentimentAuto == 'n√©gatif' %}
            {% set senti_neg = senti_neg + 1 %}
        {% else %}
            {% set senti_neutre = senti_neutre + 1 %}
        {% endif %}
    {% endfor %}
    <style>
        .creative-card { border-radius:12px; box-shadow:0 10px 30px rgba(13,110,253,0.06); padding:18px; }
        .creative-emoji { font-size:34px; }
        .status-widget { display:flex; align-items:center; gap:18px; }
        .circular-progress { width:140px; height:140px; }
        .circular-progress svg { transform:rotate(-90deg); }
        .circular-center { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center; }
    </style>

    <div class="row mb-3">
        <div class="col-md-4">
            <div class="creative-card text-center" style="background:linear-gradient(135deg,#e6fff6,#dffbf0);">
                <div class="creative-emoji">üòä</div>
                <div class="small text-muted">Positif</div>
                <div class="h4 fw-bold">{{ senti_pos }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="creative-card text-center" style="background:linear-gradient(135deg,#fbfbfd,#f3f6fb);">
                <div class="creative-emoji">üòê</div>
                <div class="small text-muted">Neutre</div>
                <div class="h4 fw-bold">{{ senti_neutre }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="creative-card text-center" style="background:linear-gradient(135deg,#fff6f6,#fff0f0);">
                <div class="creative-emoji">üòü</div>
                <div class="small text-muted">N√©gatif</div>
                <div class="h4 fw-bold">{{ senti_neg }}</div>
            </div>
        </div>
    </div>
    <table class="table table-hover align-middle shadow-sm rounded bg-white">
        <thead class="table-primary">
            <tr>
                <th>#</th>
                <th><i class="fa fa-user"></i> Nom</th>
                <th><i class="fa fa-user"></i> Pr√©nom</th>
                <th><i class="fa fa-envelope"></i> Email</th>
                <th><i class="fa fa-user-tag"></i> R√¥le</th>
                <th><i class="fa fa-info-circle"></i> Statut</th>
                <th><i class="fa fa-heading"></i> Titre</th>
                <th><i class="fa fa-align-left"></i> Description</th>
                    <th><i class="fa fa-align-justify"></i> R√©sum√© auto</th>
                <th><i class="fa fa-smile"></i> Sentiment</th>
                <th><i class="fa fa-clock"></i> Pr√©diction (jours)</th>
                <th><i class="fa fa-calendar"></i> Date</th>
                <th>Actions</th>
                <th>R√©ponses</th>
            </tr>
        </thead>
        <tbody>
        {% for reclamation in reclamations %}
            {% set hrs = reclamation.tempsResolutionAuto|default(0) %}
            {% set days = (hrs / 24)|round(0, 'floor') %}
            {% set rem = hrs - (days * 24) %}
            {% set urgent = hrs > 0 and hrs <= 4 %}
            <tr class="{{ urgent ? 'table-warning' : '' }}">
                <td><span class="badge bg-secondary">{{ reclamation.id }}</span></td>
                <td>{{ reclamation.nom|e }}</td>
                <td>{{ reclamation.prenom|e }}</td>
                <td>{{ reclamation.email|e }}</td>
                <td><span class="badge bg-info text-dark">{{ reclamation.role|capitalize }}</span></td>
                <td>
                    {% if reclamation.status == 'traiter' %}
                        <span class="badge bg-success"><i class="fa fa-check"></i> Trait√©</span>
                    {% else %}
                        <span class="badge bg-warning text-dark"><i class="fa fa-hourglass-half"></i> En cours</span>
                    {% endif %}
                </td>
                <td>{{ reclamation.titre|e }}</td>
                <td>
                    {% set shortDesc = reclamation.description|split(' ')|slice(0,20)|join(' ') %}
                    <div class="text-truncate" style="max-width:320px;">{{ shortDesc|e }}{% if reclamation.description|length > shortDesc|length %}...{% endif %}</div>
                    <button type="button" class="btn btn-sm btn-link p-0 ai-open-modal" 
                        data-id="{{ reclamation.id }}"
                        data-title="{{ reclamation.titre|e('html_attr') }}"
                        data-description="{{ reclamation.description|e('html_attr') }}"
                        data-summary="{{ reclamation.resumeAuto|default('')|e('html_attr') }}"
                        data-sentiment="{{ reclamation.sentimentAuto|default('')|e('html_attr') }}"
                        data-predicted-hours="{{ reclamation.tempsResolutionAuto|default('') }}"
                        data-email="{{ reclamation.email|e('html_attr') }}"
                        data-name="{{ (reclamation.nom ~ ' ' ~ reclamation.prenom)|trim|e('html_attr') }}"
                    >Voir l'analyse compl√®te</button>
                </td>
                <td>
                    {% set shortSum = reclamation.resumeAuto|default('')|split(' ')|slice(0,8)|join(' ') %}
                    <span title="{{ reclamation.resumeAuto|default('')|e }}">{{ shortSum|e }}{% if reclamation.resumeAuto and (reclamation.resumeAuto|split(' ')|length > 8) %}...{% endif %}</span>
                </td>
                    {# category column removed; role is already displayed earlier in table #}
                <td>
                    {% if reclamation.sentimentAuto == 'positif' %}
                        <span class="badge bg-success"><i class="fa fa-smile"></i> Positif</span>
                    {% elseif reclamation.sentimentAuto == 'n√©gatif' %}
                        <span class="badge bg-danger"><i class="fa fa-frown"></i> N√©gatif</span>
                    {% else %}
                        <span class="badge bg-secondary"><i class="fa fa-meh"></i> Neutre</span>
                    {% endif %}
                </td>
                <td style="min-width:220px;">
                    <div class="d-flex align-items-center gap-2">
                        <div style="width:80px; font-weight:700;">{% if hrs > 24 %}{{ days }}j {{ rem }}h{% else %}{{ hrs }}h{% endif %}</div>
                        <div style="flex:1">
                            <div class="progress" style="height:10px;background:rgba(0,0,0,0.05)">
                                <div class="progress-bar" role="progressbar" style="width: {{ (hrs / 168) * 100 }}%; background: {{ urgent ? '#ff7b7b' : '#0dcaf0' }};" aria-valuenow="{{ hrs }}" aria-valuemin="0" aria-valuemax="168"></div>
                            </div>
                        </div>
                        {% if urgent %}<span class="badge bg-danger">Urgent</span>{% endif %}
                    </div>
                </td>
                <td><span class="badge bg-light text-dark">{{ reclamation.dateReclamation|date('d/m/Y H:i') }}</span></td>
                <td class="text-center">
                    <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap">
                        <a href="{{ path('reclamation_show', {'id': reclamation.id}) }}" class="btn btn-warning text-white shadow-sm p-0" title="Voir" style="width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;">
                            <i class="fa fa-eye"></i>
                        </a>
                        <form method="post" action="{{ path('reclamation_delete', {'id': reclamation.id}) }}" onsubmit="return confirm('Supprimer ?');" class="m-0">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reclamation.id) }}">
                            <button class="btn btn-warning text-white shadow-sm p-0" title="Supprimer" style="width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
                <td class="text-center">
                    <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap">
                        <a href="{{ path('reponse_new', {'reclamation': reclamation.id}) }}" class="btn btn-warning text-white shadow-sm p-0" title="R√©pondre" style="width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;">
                            <i class="fa fa-reply"></i>
                        </a>
                        <a href="{{ path('reponse_index') }}?reclamation={{ reclamation.id }}" class="btn btn-warning text-white shadow-sm p-0" title="Voir r√©ponses" style="width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;">
                            <i class="fa fa-comments"></i>
                        </a>
                    </div>
                </td>
            </tr>
        {% else %}
            <tr><td colspan="11" class="text-center text-muted">Aucune r√©clamation trouv√©e.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
<!-- Widgets: satisfaction / rating statistics (placed below the reclamation table) -->
<div class="row my-4">
    <div class="col-md-6">
        <div class="card border-0 shadow h-100" style="background:linear-gradient(135deg,#6366f1,#4338ca);color:#fff;">
            <div class="card-body">
                <h5 class="card-title">Satisfaction des r√©ponses</h5>
                <div class="d-flex align-items-center">
                    <h2 class="me-3 mb-0">{{ ratingStats.avgRating|default(0) }}</h2>
                    <div>
                        {% for i in 1..5 %}
                            {% if i <= ratingStats.avgRating|default(0)|round(0,'floor') %}
                                <i class="fa fa-star text-warning"></i>
                            {% else %}
                                <i class="fa fa-star-o text-warning"></i>
                            {% endif %}
                        {% endfor %}
                        <div class="small mt-1">R√©ponses not√©es : <strong>{{ ratingStats.ratedCount|default(0) }}</strong> / {{ ratingStats.reponsesTotal|default(0) }} ({{ ratingStats.percentRated|default(0) }}%)</div>
                    </div>
                </div>
                <p class="mt-3 small">Voir <a href="{{ path('reponse_index') }}" class="text-white">G√©rer les r√©ponses</a> pour les d√©tails.</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow h-100">
            <div class="card-body">
                <h5 class="card-title">R√©partition des notes</h5>
                <canvas id="ratingChartLocal" width="400" height="160"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="row mt-4 justify-content-end align-items-center g-2">
    <div class="col-auto">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="fa fa-chart-pie"></i>
                    <strong class="small">R√©partition par statut</strong>
                </div>
                <div style="width: 260px;">
                    <canvas id="reclamationStatusChart" style="width:170px;height:170px;" width="170" height="170"></canvas>
                </div>
                <div class="mt-2 small text-muted text-truncate" style="max-width:220px;">
                    {% for item in status_breakdown %}
                        <span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:{{ item.color }}"></span>
                        {{ item.label }}: <strong>{{ item.value }}</strong>{% if not loop.last %} ‚Ä¢ {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-auto">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="fa fa-percent"></i>
                    <strong class="small">Taux de traitement</strong>
                </div>
                <div class="progress" style="height: 16px; width: 380px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ status_breakdown[0].percent }}%" aria-valuenow="{{ status_breakdown[0].percent }}" aria-valuemin="0" aria-valuemax="100">{{ status_breakdown[0].percent }}%</div>
                </div>
                <small class="text-muted d-block mt-1">{{ status_breakdown[0].value }} trait√©(s) sur {{ total_reclamations }}</small>
            </div>
        </div>
    </div>
</div>
<!-- AI Analysis Modal -->
<div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background:linear-gradient(90deg,#0dcaf0,#0b7ea1); color:#fff;">
                <h5 class="modal-title" id="aiModalTitle">Analyse de la r√©clamation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 id="aiModalTitre" class="mb-2"></h6>
                        <p id="aiModalDescription" style="white-space:pre-wrap;"></p>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3"><strong>Demandeur</strong>: <span id="aiModalName"></span></div>
                        <div class="mb-3"><strong>Email</strong>: <span id="aiModalEmail"></span></div>
                        <div class="mb-3"><strong>R√©sum√© automatique</strong><div class="p-2 bg-light rounded mt-1" id="aiModalSummary"></div></div>
                        <div class="mb-3"><strong>Sentiment</strong>: <div id="aiModalSentiment" class="mt-1"></div></div>
                        <div class="mb-3"><strong>Temps estim√©</strong>: <div id="aiModalPredicted" class="mt-1"></div></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        (function() {
            const ctx = document.getElementById('reclamationStatusChart');
            if (!ctx) return;
            const data = {
                labels: [{% for item in status_breakdown %}'{{ item.label }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for item in status_breakdown %}{{ item.value }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [{% for item in status_breakdown %}'{{ item.color }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            };
            new Chart(ctx, {
                type: 'doughnut',
                data,
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    },
                    cutout: '65%',
                    maintainAspectRatio: false,
                    aspectRatio: 2
                }
            });
        })();
    </script>
    <script>
        // Rating distribution chart for reclamation page
        (function(){
            const ctx = document.getElementById('ratingChartLocal');
            if (!ctx) return;
            const data = {{ ratingStats.ratingBuckets|default({1:0,2:0,3:0,4:0,5:0})|json_encode|raw }};
            const dataset = [data[1] ?? 0, data[2] ?? 0, data[3] ?? 0, data[4] ?? 0, data[5] ?? 0];
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['1','2','3','4','5'],
                    datasets: [{ label: 'Nombre de notes', data: dataset, backgroundColor: 'rgba(99,102,241,0.6)', borderColor:'rgba(99,102,241,1)', borderWidth:1 }]
                },
                options: { responsive:true, maintainAspectRatio:true, scales: { y: { beginAtZero:true, ticks: { stepSize:1 } } } }
            });
        })();
    </script>
    <script>
        (function(){
            // animate circular progress for status
            const arc = document.getElementById('statusArc');
            const percentEl = document.getElementById('statusPercent');
            if (arc && percentEl) {
                // compute percent from server-side value
                const pct = {{ status_breakdown[0].percent|default(0) }};
                const circumference = 2 * Math.PI * 60; // r=60
                const offset = Math.round(circumference * (1 - (pct / 100)));
                // animate
                arc.style.transition = 'stroke-dashoffset 900ms ease-out';
                setTimeout(()=>{ arc.style.strokeDashoffset = offset; percentEl.textContent = pct + '%'; }, 100);
            }
        })();
    </script>
    <script>
        (function(){
            // Modal interaction for AI analysis
            const modalEl = document.getElementById('aiAnalysisModal');
            if (!modalEl) return;
            const aiModal = new bootstrap.Modal(modalEl);

            document.querySelectorAll('.ai-open-modal').forEach(function(btn){
                btn.addEventListener('click', function(e){
                    const dataset = this.dataset;
                    document.getElementById('aiModalTitle').textContent = 'R√©clamation #' + dataset.id;
                    document.getElementById('aiModalTitre').textContent = dataset.title || '';
                    document.getElementById('aiModalDescription').textContent = dataset.description || '';
                    document.getElementById('aiModalSummary').textContent = dataset.summary || '(aucun)';
                    document.getElementById('aiModalName').textContent = dataset.name || '';
                    document.getElementById('aiModalEmail').textContent = dataset.email || '';
                    // sentiment display
                    const s = dataset.sentiment || 'neutre';
                    let sentHtml = '';
                    if (s === 'positif') sentHtml = '<span class="badge bg-success">üòä Positif</span>';
                    else if (s === 'n√©gatif') sentHtml = '<span class="badge bg-danger">üòü N√©gatif</span>';
                    else sentHtml = '<span class="badge bg-secondary">üòê Neutre</span>';
                    document.getElementById('aiModalSentiment').innerHTML = sentHtml;
                    // predicted hours
                    const hrs = parseInt(dataset.predictedHours || '0', 10);
                    let pred = hrs + 'h';
                    if (hrs >= 24) { const d = Math.floor(hrs/24); const r = hrs - d*24; pred = d + 'j ' + r + 'h'; }
                    document.getElementById('aiModalPredicted').textContent = pred;
                    aiModal.show();
                });
            });
        })();
    </script>
    <script>
        (function(){
            const btn = document.getElementById('analyzeAllBtn');
            if (!btn) return;
            btn.addEventListener('click', async function(e){
                if (!confirm('Analyser toutes les r√©clamations ? Cette op√©ration peut prendre quelques instants.')) return;
                const csrf = this.dataset.csrf || '';
                this.disabled = true;
                const original = this.innerHTML;
                this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Analyse en cours...';
                try {
                    const res = await fetch('{{ path('admin_reclamation_analyze_all') }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ _token: csrf })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        alert((data.message || 'Termin√©') + ' ‚Äî ' + (data.count || 0) + ' r√©clamation(s) analys√©e(s).');
                        location.reload();
                    } else {
                        alert('Erreur lors de l\'analyse : ' + (data.error || res.statusText));
                    }
                } catch (err) {
                    console.error(err);
                    alert('Erreur r√©seau ou inattendue');
                } finally {
                    this.disabled = false;
                    this.innerHTML = original;
                }
            });
        })();
    </script>
{% endblock %}
