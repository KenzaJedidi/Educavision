{% extends 'admin/layout.html.twig' %}

{% block title %}Simulateur d'Orientation - EducaVision{% endblock %}

{% block breadcrumb_title %}Simulateur d'Orientation{% endblock %}

{% block breadcrumb_items %}
<li>Simulateur</li>
{% endblock %}

{% block stylesheets %}
<style>
.score-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.score-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 25px;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.score-card:hover {
    transform: translateY(-5px);
}

.score-card.green-gradient {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.score-card.orange-gradient {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.score-card.blue-gradient {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.score-value {
    font-size: 3rem;
    font-weight: bold;
    margin: 10px 0;
}

.score-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.config-table {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.config-table table {
    width: 100%;
    margin: 0;
}

.config-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    font-weight: 600;
}

.config-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.config-table tr:last-child td {
    border-bottom: none;
}

.config-table tr:hover {
    background: #f8f9fa;
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.slider {
    flex: 1;
    height: 8px;
    border-radius: 5px;
    background: #e0e0e0;
    outline: none;
    -webkit-appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
}

.badge-score {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}

.matrix-grid {
    display: grid;
    grid-template-columns: 200px repeat(auto-fit, minmax(120px, 1fr));
    gap: 2px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}

.matrix-cell {
    background: white;
    padding: 15px;
    text-align: center;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.matrix-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
}

.matrix-row-header {
    background: #f8f9fa;
    font-weight: 600;
    text-align: left;
}

.matrix-input {
    width: 60px;
    text-align: center;
    border: 2px solid #e0e0e0;
    border-radius: 5px;
    padding: 5px;
    font-weight: 600;
}

.matrix-input:focus {
    border-color: #667eea;
    outline: none;
}

.stat-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.stat-badge.success {
    background: #d4edda;
    color: #155724;
}

.stat-badge.warning {
    background: #fff3cd;
    color: #856404;
}

.stat-badge.info {
    background: #d1ecf1;
    color: #0c5460;
}
</style>
{% endblock %}

{% block body %}

<!-- Statistiques en cartes -->
<div class="row m-b30">
	<div class="col-12">
		<div class="score-grid">
			<div class="score-card">
				<div class="score-label">Total Simulations</div>
				<div class="score-value">{{ simulations|length }}</div>
				<div class="score-label">Effectuées à ce jour</div>
			</div>
			
			<div class="score-card green-gradient">
				<div class="score-label">Filières Actives</div>
				<div class="score-value">12</div>
				<div class="score-label">Disponibles pour orientation</div>
			</div>
			
			<div class="score-card orange-gradient">
				<div class="score-label">Taux de Réussite</div>
				<div class="score-value">87%</div>
				<div class="score-label">Correspondance moyenne</div>
			</div>
			
			<div class="score-card blue-gradient">
				<div class="score-label">Ce Mois</div>
				<div class="score-value">+24</div>
				<div class="score-label">Nouvelles simulations</div>
			</div>
		</div>
	</div>
</div>

<!-- Configuration des scores par moyenne -->
<div class="row m-b30">
	<div class="col-lg-6">
		<div class="widget-box">
			<div class="wc-title">
				<h4><i class="fa fa-sliders"></i> Configuration des Scores - Moyenne</h4>
			</div>
			<div class="widget-inner">
				<div class="config-table">
					<table>
						<thead>
							<tr>
								<th>Tranche de Moyenne</th>
								<th>Points Attribués</th>
								<th>Pourcentage</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><strong>Moyenne ≥ 16</strong></td>
								<td>
									<div class="slider-container">
										<input type="range" min="0" max="50" value="40" class="slider" id="score-16">
										<span class="badge-score" style="background: #28a745; color: white;" id="display-16">40 pts</span>
									</div>
								</td>
								<td><span class="stat-badge success">40%</span></td>
							</tr>
							<tr>
								<td><strong>Moyenne ≥ 14</strong></td>
								<td>
									<div class="slider-container">
										<input type="range" min="0" max="50" value="30" class="slider" id="score-14">
										<span class="badge-score" style="background: #17a2b8; color: white;" id="display-14">30 pts</span>
									</div>
								</td>
								<td><span class="stat-badge info">30%</span></td>
							</tr>
							<tr>
								<td><strong>Moyenne ≥ 12</strong></td>
								<td>
									<div class="slider-container">
										<input type="range" min="0" max="50" value="20" class="slider" id="score-12">
										<span class="badge-score" style="background: #ffc107; color: white;" id="display-12">20 pts</span>
									</div>
								</td>
								<td><span class="stat-badge warning">20%</span></td>
							</tr>
							<tr>
								<td><strong>Moyenne &lt; 12</strong></td>
								<td>
									<div class="slider-container">
										<input type="range" min="0" max="50" value="10" class="slider" id="score-10">
										<span class="badge-score" style="background: #dc3545; color: white;" id="display-10">10 pts</span>
									</div>
								</td>
								<td><span class="stat-badge" style="background: #f8d7da; color: #721c24;">10%</span></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="m-t20 text-right">
					<button class="btn green radius-xl">
						<i class="fa fa-save"></i> Enregistrer les paramètres
					</button>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Poids des critères -->
	<div class="col-lg-6">
		<div class="widget-box">
			<div class="wc-title">
				<h4><i class="fa fa-pie-chart"></i> Répartition des Poids</h4>
			</div>
			<div class="widget-inner">
				<div class="config-table">
					<table>
						<thead>
							<tr>
								<th>Critère</th>
								<th>Poids</th>
								<th>Impact</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><strong><i class="fa fa-graduation-cap"></i> Moyenne Générale</strong></td>
								<td>
									<div class="slider-container">
										<input type="range" min="0" max="100" value="40" class="slider" id="weight-moyenne">
										<span class="badge-score" style="background: #667eea; color: white;" id="display-moyenne">40%</span>
									</div>
								</td>
								<td><span class="stat-badge" style="background: #667eea; color: white;">Élevé</span></td>
							</tr>
							<tr>
								<td><strong><i class="fa fa-book"></i> Spécialités</strong></td>
								<td>
									<div class="slider-container">
										<input type="range" min="0" max="100" value="40" class="slider" id="weight-specialites">
										<span class="badge-score" style="background: #11998e; color: white;" id="display-specialites">40%</span>
									</div>
								</td>
								<td><span class="stat-badge" style="background: #11998e; color: white;">Élevé</span></td>
							</tr>
							<tr>
								<td><strong><i class="fa fa-heart"></i> Préférences</strong></td>
								<td>
									<div class="slider-container">
										<input type="range" min="0" max="100" value="20" class="slider" id="weight-preferences">
										<span class="badge-score" style="background: #f5576c; color: white;" id="display-preferences">20%</span>
									</div>
								</td>
								<td><span class="stat-badge" style="background: #f5576c; color: white;">Moyen</span></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="alert alert-info m-t20">
					<strong><i class="fa fa-info-circle"></i> Total :</strong> 
					<span id="total-weight" style="font-size: 1.2rem; font-weight: bold;">100%</span>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Matrice Spécialités × Filières -->
<div class="row m-b30">
	<div class="col-lg-12">
		<div class="widget-box">
			<div class="wc-title">
				<h4><i class="fa fa-table"></i> Matrice : Spécialités × Filières (Points Bonus)</h4>
				<small style="opacity: 0.7;">Configurez les points bonus accordés selon les spécialités choisies</small>
			</div>
			<div class="widget-inner">
				<div style="overflow-x: auto;">
					<div class="matrix-grid">
						<!-- En-tête -->
						<div class="matrix-cell matrix-header">Spécialité / Filière</div>
						<div class="matrix-cell matrix-header">Médecine</div>
						<div class="matrix-cell matrix-header">Ingénierie</div>
						<div class="matrix-cell matrix-header">Droit</div>
						<div class="matrix-cell matrix-header">Commerce</div>
						<div class="matrix-cell matrix-header">Informatique</div>
						
						<!-- Lignes -->
						<div class="matrix-cell matrix-row-header"><i class="fa fa-flask"></i> Physique-Chimie</div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="15" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="20" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="5" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="0" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="10" min="0" max="50"></div>
						
						<div class="matrix-cell matrix-row-header"><i class="fa fa-leaf"></i> SVT (Biologie)</div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="25" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="10" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="0" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="5" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="5" min="0" max="50"></div>
						
						<div class="matrix-cell matrix-row-header"><i class="fa fa-calculator"></i> Mathématiques</div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="10" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="25" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="5" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="15" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="25" min="0" max="50"></div>
						
						<div class="matrix-cell matrix-row-header"><i class="fa fa-balance-scale"></i> Sciences Éco & Sociales</div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="0" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="5" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="20" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="25" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="10" min="0" max="50"></div>
						
						<div class="matrix-cell matrix-row-header"><i class="fa fa-code"></i> NSI (Informatique)</div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="5" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="20" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="5" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="15" min="0" max="50"></div>
						<div class="matrix-cell"><input type="number" class="matrix-input" value="30" min="0" max="50"></div>
					</div>
				</div>
				<div class="m-t20 text-right">
					<button class="btn blue radius-xl outline">
						<i class="fa fa-refresh"></i> Réinitialiser
					</button>
					<button class="btn green radius-xl">
						<i class="fa fa-save"></i> Enregistrer la matrice
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Historique des simulations -->
<div class="row">
	<div class="col-lg-12">
		<div class="widget-box">
			<div class="wc-title">
				<h4><i class="fa fa-history"></i> Historique des Simulations</h4>
			</div>
			<div class="widget-inner">
				{% if simulations|length > 0 %}
					<div class="table-responsive">
						<table class="table table-hover">
							<thead style="background: #f8f9fa;">
								<tr>
									<th><i class="fa fa-calendar"></i> Date</th>
									<th><i class="fa fa-graduation-cap"></i> Moyenne</th>
									<th><i class="fa fa-book"></i> Spécialités</th>
									<th><i class="fa fa-trophy"></i> Meilleure Filière</th>
									<th><i class="fa fa-percent"></i> Score</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for simulation in simulations %}
									<tr>
										<td>{{ simulation.dateSimulation|date('d/m/Y H:i') }}</td>
										<td><strong>{{ simulation.moyenne }}/20</strong></td>
										<td><span class="badge badge-info">{{ simulation.specialites|length }} spé.</span></td>
										<td>
											{% if simulation.resultats|length > 0 %}
												<strong>{{ simulation.resultats[0].filiere }}</strong>
											{% else %}
												-
											{% endif %}
										</td>
										<td>
											{% if simulation.resultats|length > 0 %}
												<span class="badge-score" style="background: #28a745; color: white;">
													{{ simulation.resultats[0].pourcentage }}%
												</span>
											{% else %}
												-
											{% endif %}
										</td>
										<td>
											<button class="btn btn-sm blue" data-toggle="modal" data-target="#resultModal{{ simulation.id }}">
												<i class="fa fa-eye"></i> Détails
											</button>
										</td>
									</tr>
									
									<!-- Modal -->
									<div class="modal fade" id="resultModal{{ simulation.id }}" tabindex="-1">
										<div class="modal-dialog modal-lg">
											<div class="modal-content">
												<div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
													<h5 class="modal-title">
														<i class="fa fa-bar-chart"></i> Résultats Détaillés
													</h5>
													<button type="button" class="close" data-dismiss="modal" style="color: white;">
														<span>&times;</span>
													</button>
												</div>
												<div class="modal-body">
													<div class="row m-b20">
														<div class="col-md-4">
															<strong>Moyenne :</strong> {{ simulation.moyenne }}/20
														</div>
														<div class="col-md-8">
															<strong>Spécialités :</strong> 
															{% for spe in simulation.specialites %}
																<span class="badge badge-primary">{{ spe }}</span>
															{% endfor %}
														</div>
													</div>
													
													<h6 class="m-t20"><i class="fa fa-trophy"></i> Filières Recommandées :</h6>
													<div class="table-responsive">
														<table class="table table-striped">
															<thead>
																<tr>
																	<th>Position</th>
																	<th>Filière</th>
																	<th>Compatibilité</th>
																</tr>
															</thead>
															<tbody>
																{% for result in simulation.resultats %}
																	<tr>
																		<td>
																			{% if loop.index == 1 %}
																				<i class="fa fa-trophy" style="color: gold;"></i>
																			{% elseif loop.index == 2 %}
																				<i class="fa fa-trophy" style="color: silver;"></i>
																			{% elseif loop.index == 3 %}
																				<i class="fa fa-trophy" style="color: #cd7f32;"></i>
																			{% else %}
																				{{ loop.index }}
																			{% endif %}
																		</td>
																		<td><strong>{{ result.filiere }}</strong></td>
																		<td>
																			<div class="progress" style="height: 25px;">
																				<div class="progress-bar bg-success" role="progressbar" 
																				     style="width: {{ result.pourcentage }}%;" 
																				     aria-valuenow="{{ result.pourcentage }}" 
																				     aria-valuemin="0" 
																				     aria-valuemax="100">
																					{{ result.pourcentage }}%
																				</div>
																			</div>
																		</td>
																	</tr>
																{% endfor %}
															</tbody>
														</table>
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn red outline radius-xl" data-dismiss="modal">Fermer</button>
												</div>
											</div>
										</div>
									</div>
								{% endfor %}
							</tbody>
						</table>
					</div>
				{% else %}
					<div class="alert alert-info">
						<i class="fa fa-info-circle"></i> Aucune simulation n'a encore été effectuée.
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
// Sliders interactifs pour les scores
['16', '14', '12', '10'].forEach(function(id) {
    const slider = document.getElementById('score-' + id);
    const display = document.getElementById('display-' + id);
    
    slider.addEventListener('input', function() {
        display.textContent = this.value + ' pts';
    });
});

// Sliders pour les poids
['moyenne', 'specialites', 'preferences'].forEach(function(id) {
    const slider = document.getElementById('weight-' + id);
    const display = document.getElementById('display-' + id);
    
    slider.addEventListener('input', function() {
        display.textContent = this.value + '%';
        updateTotalWeight();
    });
});

function updateTotalWeight() {
    const moyenne = parseInt(document.getElementById('weight-moyenne').value);
    const specialites = parseInt(document.getElementById('weight-specialites').value);
    const preferences = parseInt(document.getElementById('weight-preferences').value);
    const total = moyenne + specialites + preferences;
    
    document.getElementById('total-weight').textContent = total + '%';
    document.getElementById('total-weight').style.color = total === 100 ? '#28a745' : '#dc3545';
}
</script>
{% endblock %}
