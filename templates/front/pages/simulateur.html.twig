{% extends 'front/base.html.twig' %}

{% block title %}Simulateur d'Orientation - EducaVision{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Variables de couleurs */
    :root {
        --primary-orange: #FF9800;
        --primary-blue: #1E3A5F;
        --light-orange: #FFF3E0;
        --light-blue: #E8F4FD;
        --border-color: #E0E0E0;
        --text-primary: #2C3E50;
        --text-secondary: #546E7A;
        --success: #4CAF50;
        --warning: #FF9800;
        --danger: #F44336;
    }

    /* Structure principale */
    .simulator-page {
        background: #F9FAFC;
        min-height: 100vh;
        padding: 40px 0;
    }

    .simulator-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* En-t√™te */
    .page-header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 30px;
        border-bottom: 2px solid var(--border-color);
    }

    .page-header h1 {
        color: var(--primary-blue);
        font-weight: 700;
        font-size: 2.5rem;
        margin: 0 0 15px 0;
    }

    .page-header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin: 0;
    }

    /* Carte principale */
    .simulator-card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .card-header {
        padding: 25px 30px;
        background: linear-gradient(135deg, var(--primary-orange), #FFB74D);
        border-bottom: none;
    }

    .card-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .card-body {
        padding: 30px;
    }

    /* Formulaire */
    .form-group {
        margin-bottom: 30px;
    }

    .form-label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .form-label i {
        margin-right: 8px;
        color: var(--primary-orange);
    }

    .form-label .required {
        color: var(--danger);
        margin-left: 3px;
    }

    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-orange);
        box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .input-group {
        display: flex;
    }

    .input-group .form-control {
        border-radius: 8px 0 0 8px;
        border-right: 0;
    }

    .input-group-text {
        background: var(--light-orange);
        border: 2px solid var(--border-color);
        border-left: 0;
        border-radius: 0 8px 8px 0;
        padding: 0 20px;
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 1rem;
    }

    .form-hint {
        display: block;
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Compteur sp√©cialit√©s */
    .spec-counter {
        background: var(--light-blue);
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--primary-blue);
    }

    .spec-counter .counter {
        background: white;
        padding: 4px 12px;
        border-radius: 20px;
        color: var(--primary-orange);
    }

    /* Grille de checkboxes */
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 10px;
    }

    .checkbox-item {
        position: relative;
    }

    .checkbox-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }

    .checkbox-label {
        display: block;
        padding: 12px 15px;
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s;
        color: var(--text-primary);
    }

    .checkbox-item input[type="checkbox"]:checked + .checkbox-label {
        background: var(--light-orange);
        border-color: var(--primary-orange);
        color: var(--primary-blue);
        font-weight: 600;
        transform: scale(1.02);
    }

    .checkbox-label:hover {
        border-color: var(--primary-orange);
        transform: translateY(-2px);
    }

    .checkbox-item input[type="checkbox"]:disabled + .checkbox-label {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Bouton de soumission */
    .btn-submit {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, var(--primary-orange), #FFB74D);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(255, 152, 0, 0.2);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 152, 0, 0.3);
    }

    .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .simulator-page {
            padding: 20px 0;
        }

        .page-header h1 {
            font-size: 2rem;
        }

        .card-body {
            padding: 20px;
        }

        .checkbox-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 576px) {
        .checkbox-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Animation de chargement */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .btn-submit.loading i {
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}

{% block body %}
<!-- Page Title -->
<div class="page-banner ovbl-dark" style="background-image:url({{ asset('front-assets/images/banner/banner1.jpg') }});">
    <div class="container">
        <div class="page-banner-entry">
            <h1 class="text-white">Simulateur d'Orientation</h1>
        </div>
    </div>
</div>

<!-- Breadcrumb -->
<div class="breadcrumb-row">
    <div class="container">
        <ul class="list-inline">
            <li><a href="{{ path('front_home') }}">Accueil</a></li>
            <li>Simulateur d'Orientation</li>
        </ul>
    </div>
</div>

<!-- Simulateur -->
<div class="simulator-page">
    <div class="simulator-container">
        <!-- En-t√™te -->
        <div class="page-header">
            <h1>Simulateur d'Orientation</h1>
            <p>D√©couvrez les fili√®res qui correspondent √† votre profil acad√©mique</p>
        </div>

        <!-- Formulaire de simulation -->
        <div class="simulator-card">
            <div class="card-header">
                <h2><i class="fas fa-calculator"></i> Simulez votre orientation</h2>
            </div>
            <div class="card-body">
                <form id="simulation-form" method="post">
                    <!-- Moyenne g√©n√©rale -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-star"></i> Moyenne G√©n√©rale
                            <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   name="moyenne" 
                                   id="moyenne"
                                   class="form-control" 
                                   min="0" 
                                   max="20" 
                                   step="0.1" 
                                   value="15.5"
                                   required
                                   placeholder="Ex: 15.5">
                            <span class="input-group-text">/20</span>
                        </div>
                        <span class="form-hint">Votre moyenne scolaire sur 20 points</span>
                    </div>

                    <!-- Sp√©cialit√©s -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-book-open"></i> Sp√©cialit√©s
                            <span class="required">*</span>
                        </label>
                        
                        <div class="spec-counter">
                            <span>Sp√©cialit√©s s√©lectionn√©es</span>
                            <span class="counter">3/3</span>
                        </div>

                        <div class="checkbox-grid">
                            {% set specialites = ['Math√©matiques', 'Physique-Chimie', 'SVT', 'NSI', 'SES', 'Litt√©rature', 'Philosophie', 'Histoire-G√©ographie', 'Arts', 'Langues'] %}
                            {% for spe in specialites %}
                            <div class="checkbox-item">
                                <input type="checkbox" 
                                       id="spe-{{ loop.index }}" 
                                       name="specialites[]" 
                                       value="{{ spe }}"
                                       class="spec-checkbox"
                                       {% if spe in ['Math√©matiques', 'Physique-Chimie', 'SVT'] %}checked{% endif %}>
                                <label for="spe-{{ loop.index }}" class="checkbox-label">{{ spe }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <span class="form-hint">S√©lectionnez exactement 3 sp√©cialit√©s</span>
                    </div>

                    <!-- Centres d'int√©r√™t -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-heart"></i> Centres d'int√©r√™t
                            <small style="color: var(--text-secondary); font-weight: 400;">(optionnel)</small>
                        </label>

                        <div class="checkbox-grid">
                            {% set preferences = ['Scientifique', 'Litt√©raire', 'Social', 'Technique', 'Cr√©atif', 'Analytique', 'Relationnel', 'Logique', 'Humain'] %}
                            {% for pref in preferences %}
                            <div class="checkbox-item">
                                <input type="checkbox" 
                                       id="pref-{{ loop.index }}" 
                                       name="preferences[]" 
                                       value="{{ pref }}"
                                       {% if pref in ['Scientifique', 'Technique'] %}checked{% endif %}>
                                <label for="pref-{{ loop.index }}" class="checkbox-label">{{ pref }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <span class="form-hint">S√©lectionnez vos domaines d'int√©r√™t (optionnel)</span>
                    </div>

                    <!-- Bouton de soumission -->
                    <button type="submit" class="btn-submit" id="submit-btn">
                        <i class="fas fa-rocket"></i> Lancer la Simulation
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{# ===== SECTION CONSEILLER IA ===== #}
<div style="background:#f4f6ff;padding:60px 0;margin-top:0;border-top:3px solid #667eea;">
    <div class="container">
        <div style="max-width:820px;margin:0 auto;">

            {# En-t√™te #}
            <div style="text-align:center;margin-bottom:40px;">
                <div style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:50px;padding:7px 20px;font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:18px;">
                    <i class="fa fa-robot"></i> Intelligence Artificielle
                </div>
                <h2 style="font-size:2rem;font-weight:800;color:#1a1a2e;margin-bottom:12px;line-height:1.25;">
                    üß† Conseiller d'Orientation Intelligent
                </h2>
                <p style="color:#666;font-size:1.05rem;max-width:580px;margin:0 auto;line-height:1.7;">
                    Le simulateur vous aide avec des crit√®res acad√©miques. Notre IA va plus loin¬†:
                    <strong>d√©crivez librement votre profil</strong> et elle d√©tecte vos comp√©tences cach√©es.
                </p>
            </div>

            {# Trois atouts #}
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:40px;">
                <div style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 4px 18px rgba(102,126,234,0.1);border-top:3px solid #667eea;text-align:center;">
                    <div style="font-size:2.2rem;margin-bottom:10px;">üîç</div>
                    <div style="font-weight:700;color:#1a1a2e;margin-bottom:6px;">D√©tection des comp√©tences</div>
                    <div style="color:#888;font-size:0.85rem;line-height:1.6;">L'IA identifie vos talents et aptitudes implicites √† partir de votre texte.</div>
                </div>
                <div style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 4px 18px rgba(102,126,234,0.1);border-top:3px solid #764ba2;text-align:center;">
                    <div style="font-size:2.2rem;margin-bottom:10px;">üéØ</div>
                    <div style="font-weight:700;color:#1a1a2e;margin-bottom:6px;">Fili√®res sur mesure</div>
                    <div style="color:#888;font-size:0.85rem;line-height:1.6;">Elle compare avec toutes les fili√®res disponibles et vous propose les meilleures.</div>
                </div>
                <div style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 4px 18px rgba(102,126,234,0.1);border-top:3px solid #28a745;text-align:center;">
                    <div style="font-size:2.2rem;margin-bottom:10px;">‚ö°</div>
                    <div style="font-weight:700;color:#1a1a2e;margin-bottom:6px;">R√©sultat instantan√©</div>
                    <div style="color:#888;font-size:0.85rem;line-height:1.6;">En quelques secondes, recevez une analyse compl√®te et personnalis√©e.</div>
                </div>
            </div>

            {# Exemple d'i/o #}
            <div style="background:#fff;border-radius:16px;padding:28px 32px;box-shadow:0 4px 18px rgba(0,0,0,0.07);margin-bottom:36px;display:flex;gap:24px;flex-wrap:wrap;align-items:center;">
                <div style="flex:1;min-width:200px;">
                    <div style="color:#aaa;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Vous √©crivez</div>
                    <div style="background:#f8f9ff;border-left:3px solid #667eea;border-radius:8px;padding:14px 16px;font-size:0.9rem;color:#444;font-style:italic;line-height:1.6;">
                        &laquo;¬†Je suis passionn√© par la technologie et j'aime r√©soudre des probl√®mes complexes...¬†&raquo;
                    </div>
                </div>
                <div style="font-size:1.8rem;color:#ccc;align-self:center;">‚Üí</div>
                <div style="flex:1;min-width:200px;">
                    <div style="color:#aaa;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">L'IA vous propose</div>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <span style="background:#e8f5e9;color:#2e7d32;border-radius:50px;padding:4px 12px;font-size:0.8rem;font-weight:600;display:inline-block;width:fit-content;">G√©nie Informatique</span>
                        <span style="background:#ede7f6;color:#512da8;border-radius:50px;padding:4px 12px;font-size:0.8rem;font-weight:600;display:inline-block;width:fit-content;">Data Science</span>
                        <span style="background:#e3f2fd;color:#1565c0;border-radius:50px;padding:4px 12px;font-size:0.8rem;font-weight:600;display:inline-block;width:fit-content;">Intelligence Artificielle</span>
                    </div>
                </div>
            </div>

            {# Bouton principal #}
            <div style="text-align:center;">
                <a href="{{ path('ai_orientation_index') }}" style="display:inline-flex;align-items:center;gap:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:50px;padding:18px 48px;font-weight:800;font-size:1.1rem;text-decoration:none;box-shadow:0 8px 28px rgba(102,126,234,0.45);transition:all 0.3s;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 14px 36px rgba(102,126,234,0.55)'" onmouseout="this.style.transform='';this.style.boxShadow='0 8px 28px rgba(102,126,234,0.45)'">
                    <i class="fa fa-brain" style="font-size:1.3rem;"></i>
                    Analyser mon profil avec l'IA
                    <i class="fa fa-arrow-right"></i>
                </a>
                <div style="margin-top:14px;color:#aaa;font-size:0.82rem;">Gratuit &bull; Instantan√© &bull; Sans inscription</div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des sp√©cialit√©s (max 3)
    const specCheckboxes = document.querySelectorAll('.spec-checkbox');
    const counter = document.querySelector('.spec-counter .counter');

    function updateSpecCounter() {
        const checked = Array.from(specCheckboxes).filter(cb => cb.checked);
        counter.textContent = checked.length + '/3';

        // D√©sactiver les autres si 3 sont coch√©es
        if (checked.length >= 3) {
            specCheckboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = true;
                    cb.parentElement.style.opacity = '0.5';
                }
            });
        } else {
            specCheckboxes.forEach(cb => {
                cb.disabled = false;
                cb.parentElement.style.opacity = '1';
            });
        }
    }

    specCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const checked = Array.from(specCheckboxes).filter(c => c.checked);
            if (checked.length > 3) {
                this.checked = false;
            }
            updateSpecCounter();
        });
    });

    // Initialiser le compteur
    updateSpecCounter();

    // Gestion de la soumission du formulaire
    const form = document.getElementById('simulation-form');
    const submitBtn = document.getElementById('submit-btn');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Validation de la moyenne
        const moyenne = parseFloat(document.getElementById('moyenne').value);
        if (isNaN(moyenne) || moyenne < 0 || moyenne > 20) {
            alert('‚ö†Ô∏è La moyenne doit √™tre un nombre entre 0 et 20 !');
            return;
        }

        // Validation des sp√©cialit√©s (exactement 3)
        const checked = Array.from(specCheckboxes).filter(cb => cb.checked);
        if (checked.length !== 3) {
            alert('‚ö†Ô∏è Vous devez s√©lectionner exactement 3 sp√©cialit√©s !');
            return;
        }

        // R√©cup√©rer les donn√©es du formulaire
        const specialites = [];
        const preferences = [];
        
        // R√©cup√©rer les sp√©cialit√©s coch√©es
        specCheckboxes.forEach(cb => {
            if (cb.checked) {
                specialites.push(cb.value);
            }
        });
        
        // R√©cup√©rer les pr√©f√©rences coch√©es
        document.querySelectorAll('input[name="preferences[]"]:checked').forEach(cb => {
            preferences.push(cb.value);
        });

        // Pr√©parer les donn√©es pour l'envoi
        const data = {
            moyenne: moyenne,
            specialites: specialites,
            preferences: preferences
        };

        console.log('Donn√©es envoy√©es:', data);

        // D√©sactiver le bouton et afficher le chargement
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner"></i> Calcul en cours...';
        submitBtn.classList.add('loading');

        // Envoyer la requ√™te AJAX
        fetch('{{ path('front_simulateur_calcul') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('R√©ponse re√ßue:', response.status, response.statusText);
            
            // Si la r√©ponse n'est pas OK, essayer de lire le message d'erreur
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.message || 'Erreur HTTP: ' + response.status);
                }).catch(() => {
                    throw new Error('Erreur HTTP: ' + response.status);
                });
            }
            return response.json();
        })
        .then(result => {
            console.log('R√©sultat:', result);
            
            if (result.success) {
                // Construire l'URL avec l'ID - CORRECTION IMPORTANTE
                const resultsUrl = '/simulateur/resultats/' + result.data.simulation_id;
                console.log('Redirection vers:', resultsUrl);
                
                // Rediriger vers la page de r√©sultats
                window.location.href = resultsUrl;
            } else {
                // Afficher le message d'erreur du serveur
                const errorMsg = result.message || 'Une erreur inconnue est survenue.';
                if (result.error_details) {
                    console.error('D√©tails de l\'erreur:', result.error_details);
                }
                alert('‚ùå ' + errorMsg);
                
                // R√©activer le bouton
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-rocket"></i> Lancer la Simulation';
                submitBtn.classList.remove('loading');
            }
        })
        .catch(error => {
            console.error('Erreur d√©taill√©e:', error);
            
            // Message d'erreur am√©lior√©
            let errorMessage = 'Une erreur est survenue lors de la simulation. ';
            errorMessage += 'Veuillez v√©rifier votre connexion et r√©essayer.';
            
            if (error.message.includes('HTTP')) {
                errorMessage += '\n\nErreur technique: ' + error.message;
            }
            
            alert('‚ùå ' + errorMessage);
            
            // R√©activer le bouton
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-rocket"></i> Lancer la Simulation';
            submitBtn.classList.remove('loading');
        });
    });
});
</script>
{% endblock %}