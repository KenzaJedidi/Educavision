{% extends 'front/base.html.twig' %}

{% block title %}Discussions - {{ course.titre }} - EducaVision{% endblock %}

{% block body %}
<!-- Page Title -->
<div class="page-banner ovbl-dark" style="background-image:url({{ asset('front-assets/images/banner/discussion-banner.jpg') }});">
    <div class="container">
        <div class="page-banner-entry">
            <h1 class="text-white">Discussions du cours</h1>
            <div class="breadcrumb-row">
                <ul class="list-inline">
                    <li><a href="{{ path('front_home') }}">Accueil</a></li>
                    <li><a href="{{ path('front_cours_list') }}">Cours</a></li>
                    <li><a href="{{ path('front_cours_show', {'id': course.id}) }}">{{ course.titre }}</a></li>
                    <li>Discussions</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Content -->
<div class="content-block">
    <div class="section-area section-sp2">
        <div class="container">
            <div class="row">
                <!-- Filtre par étudiant -->
                <div class="col-md-12 mb-4">
                    <div class="filter-card">
                        <h4>Filtrer par étudiant</h4>
                        <form method="GET" action="{{ path('front_cours_discussion', {'id': course.id}) }}">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" 
                                           name="student" 
                                           class="form-control" 
                                           placeholder="Entrez le nom de l'étudiant..."
                                           value="{{ studentName }}">
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fa fa-search"></i> Rechercher
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Section de recherche et de réponse -->
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Rechercher une conversation</h4>
                            </div>
                            <div class="card-body">
                                <form method="GET" action="{{ path('front_cours_discussion', {'id': course.id}) }}" class="conversation-search">
                                    <div class="form-group">
                                        <label for="student_search" class="form-label">
                                            <i class="fa fa-search"></i> Rechercher par étudiant
                                        </label>
                                        <input 
                                            type="text" 
                                            name="student" 
                                            id="student_search" 
                                            class="form-control" 
                                            placeholder="Entrez le nom de l'étudiant..."
                                            value="{{ studentName }}"
                                        >
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-search"></i> Rechercher
                                    </button>
                                    {% if studentName %}
                                        <a href="{{ path('front_cours_discussion', {'id': course.id}) }}" class="btn btn-outline-secondary">
                                            <i class="fa fa-times"></i> Effacer
                                        </a>
                                    {% endif %}
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Envoyer un message au professeur</h4>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ path('front_cours_message', {'id': course.id}) }}" class="message-form">
                                    <div class="form-group">
                                        <label for="student_name" class="form-label">
                                            <i class="fa fa-user"></i> Votre nom
                                        </label>
                                        <input 
                                            type="text" 
                                            name="student_name" 
                                            id="student_name" 
                                            class="form-control" 
                                            placeholder="Votre nom complet"
                                            required
                                        >
                                    </div>
                                    <div class="form-group">
                                        <label for="student_email" class="form-label">
                                            <i class="fa fa-envelope"></i> Votre email
                                        </label>
                                        <input 
                                            type="email" 
                                            name="student_email" 
                                            id="student_email" 
                                            class="form-control" 
                                            placeholder="votre.email@exemple.com"
                                        >
                                    </div>
                                    <div class="form-group">
                                        <label for="message_content" class="form-label">
                                            <i class="fa fa-comment"></i> Votre message
                                        </label>
                                        <textarea 
                                            name="content" 
                                            id="message_content" 
                                            class="form-control" 
                                            rows="4" 
                                            placeholder="Décrivez votre question ou votre message..."
                                            required
                                        ></textarea>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-paper-plane"></i> Envoyer le message
                                        </button>
                                        <a href="{{ path('front_cours_show', {'id': course.id}) }}" class="btn btn-outline-secondary">
                                            <i class="fa fa-arrow-left"></i> Retour au cours
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste des discussions -->
                <div class="col-md-8">
                    <div class="discussions-card">
                        <h3>
                            <i class="fa fa-comments"></i> 
                            Discussions pour "{{ course.titre }}"
                            {% if studentName %}
                                <small class="text-muted">- {{ studentName }}</small>
                            {% endif %}
                        </h3>
                        
                        {% if messages|length > 0 %}
                            <div class="discussions-list">
                                {% for message in messages %}
                                <div class="discussion-item">
                                    <div class="discussion-header">
                                        <div class="discussion-info">
                                            <h5>{{ message.title }}</h5>
                                            <p class="text-muted mb-1">
                                                <i class="fa fa-user"></i> {{ message.student }}
                                                {% if message.teacher %}
                                                    <span class="mx-2">↔</span>
                                                    <i class="fa fa-chalkboard-teacher"></i> {{ message.teacher }}
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="discussion-status">
                                            {% if message.isRead %}
                                                <span class="badge badge-success">
                                                    <i class="fa fa-check"></i> Lu
                                                </span>
                                            {% else %}
                                                <span class="badge badge-warning">
                                                    <i class="fa fa-envelope"></i> Non lu
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Vue de la discussion complète -->
                                    <div class="discussion-thread mt-3">
                                        <!-- Afficher tous les messages de la conversation -->
                                        {% set conversationMessages = message.conversationMessages %}
                                        
                                        {% if conversationMessages|length > 0 %}
                                            {% for convMessage in conversationMessages %}
                                                <div class="message-bubble {% if convMessage.isTeacher() %}teacher-message{% else %}student-message{% endif %}">
                                                    <div class="message-header">
                                                        <div class="message-sender">
                                                            {% if convMessage.isTeacher() %}
                                                                <i class="fa fa-chalkboard-teacher"></i> {{ convMessage.senderName }}
                                                            {% else %}
                                                                <i class="fa fa-user"></i> {{ convMessage.senderName }}
                                                            {% endif %}
                                                            <span class="message-date">{{ convMessage.createdAt|date('d/m/Y H:i') }}</span>
                                                        </div>
                                                    </div>
                                                    <div class="message-content">
                                                        <p>{{ convMessage.content|raw }}</p>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <!-- Fallback : afficher le message original et le dernier message -->
                                            <!-- Message initial de l'étudiant -->
                                            <div class="message-bubble student-message">
                                                <div class="message-header">
                                                    <div class="message-sender">
                                                        <i class="fa fa-user"></i> {{ message.student }}
                                                        <span class="message-date">{{ message.createdAt|date('d/m/Y H:i') }}</span>
                                                    </div>
                                                </div>
                                                <div class="message-content">
                                                    <p>{{ message.content|raw }}</p>
                                                </div>
                                            </div>
                                            
                                            <!-- Dernier message (réponse du prof ou étudiant) -->
                                            {% if message.lastMessage %}
                                            {% set isTeacherReply = (message.messageCount % 2 == 1 and message.teacher) %}
                                            <div class="message-bubble {% if isTeacherReply %}teacher-message{% else %}student-message{% endif %}">
                                                <div class="message-header">
                                                    <div class="message-sender">
                                                        {% if isTeacherReply %}
                                                            <i class="fa fa-chalkboard-teacher"></i> {{ message.teacher }}
                                                        {% else %}
                                                            <i class="fa fa-user"></i> {{ message.student }}
                                                        {% endif %}
                                                        <span class="message-date">{{ message.lastMessageAt|date('d/m/Y H:i') }}</span>
                                                    </div>
                                                </div>
                                                <div class="message-content">
                                                    <p>{{ message.lastMessage|raw }}</p>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <!-- Indicateur de nombre de messages -->
                                        {% if message.messageCount > 2 and conversationMessages|length == 0 %}
                                        <div class="more-messages-indicator text-center">
                                            <span class="badge badge-info">
                                                <i class="fa fa-comments"></i> {{ message.messageCount - 2 }} message{{ (message.messageCount - 2) > 1 ? 's' : '' }} supplémentaire{{ (message.messageCount - 2) > 1 ? 's' : '' }}
                                            </span>
                                        </div>
                                        {% endif %}
                                            <form method="POST" action="{{ path('front_cours_student_reply', {'id': course.id, 'messageId': message.id}) }}" class="reply-form">
                                                <div class="form-group">
                                                    <label for="student_reply_{{ message.id }}" class="form-label">
                                                        Votre réponse
                                                    </label>
                                                    <textarea 
                                                        name="reply_content" 
                                                        id="student_reply_{{ message.id }}" 
                                                        class="form-control" 
                                                        rows="3" 
                                                        placeholder="Écrivez votre réponse au professeur..."
                                                        required
                                                    ></textarea>
                                                </div>
                                                <div class="reply-actions">
                                                    <button type="submit" class="btn btn-primary btn-sm">
                                                        <i class="fa fa-paper-plane"></i> Envoyer la réponse
                                                    </button>
                                                    <small class="text-muted">
                                                        <i class="fa fa-info-circle"></i> Votre réponse sera ajoutée à cette discussion
                                                    </small>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <div class="discussion-content">
                                        <p>{{ message.content|striptags|slice(0, 200) }}...</p>
                                    </div>
                                    
                                    <div class="discussion-meta">
                                        <div class="meta-info">
                                            <span class="text-muted">
                                                <i class="fa fa-calendar"></i> 
                                                Créé le {{ message.createdAt|date('d/m/Y H:i') }}
                                            </span>
                                            {% if message.lastMessageAt %}
                                                <span class="text-muted ml-3">
                                                    <i class="fa fa-reply"></i> 
                                                    Dernier message le {{ message.lastMessageAt|date('d/m/Y H:i') }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="message-count">
                                            <span class="badge badge-info">
                                                <i class="fa fa-comment"></i> {{ message.messageCount }} message{{ message.messageCount > 1 ? 's' : '' }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    {% if message.lastMessage %}
                                    <div class="last-message">
                                        <strong>Dernier message:</strong>
                                        <p class="mb-0">{{ message.lastMessage|striptags|slice(0, 150) }}...</p>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="no-discussions">
                                <div class="text-center py-5">
                                    <i class="fa fa-comments fa-3x text-muted mb-3"></i>
                                    <h4>Aucune discussion trouvée</h4>
                                    {% if studentName %}
                                        <p class="text-muted">
                                            Aucune discussion trouvée pour l'étudiant "{{ studentName }}".
                                        </p>
                                        <a href="{{ path('front_cours_discussion', {'id': course.id}) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="fa fa-times"></i> Annuler le filtre
                                        </a>
                                    {% else %}
                                        <p class="text-muted">
                                            Soyez le premier à démarrer une discussion pour ce cours !
                                        </p>
                                        <a href="{{ path('front_cours_message', {'id': course.id}) }}" 
                                           class="btn btn-primary">
                                            <i class="fa fa-plus"></i> Démarrer une discussion
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Colonne latérale -->
                <div class="col-md-4">
                    <!-- Actions -->
                    <div class="actions-card mb-4">
                        <h4>Actions</h4>
                        <div class="action-buttons">
                            <a href="{{ path('front_cours_message', {'id': course.id}) }}" 
                               class="btn btn-primary btn-block mb-2">
                                <i class="fa fa-plus"></i> Nouvelle discussion
                            </a>
                            
                            <a href="{{ path('front_cours_show', {'id': course.id}) }}" 
                               class="btn btn-outline-primary btn-block mb-2">
                                <i class="fa fa-arrow-left"></i> Retour au cours
                            </a>
                            
                            {% if studentName %}
                                <a href="{{ path('front_cours_discussion', {'id': course.id}) }}" 
                                   class="btn btn-outline-secondary btn-block">
                                    <i class="fa fa-times"></i> Annuler le filtre
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div class="stats-card mb-4">
                        <h4>Statistiques</h4>
                        <div class="stats-list">
                            <div class="stat-item">
                                <i class="fa fa-comments"></i>
                                <div class="stat-info">
                                    <span class="stat-number">{{ messages|length }}</span>
                                    <span class="stat-label">Discussion{{ messages|length > 1 ? 's' : '' }}</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <i class="fa fa-envelope"></i>
                                <div class="stat-info">
                                    <span class="stat-number">{{ messages|filter(m => not m.isRead)|length }}</span>
                                    <span class="stat-label">Non lu{{ messages|filter(m => not m.isRead)|length > 1 ? 's' : '' }}</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <i class="fa fa-users"></i>
                                <div class="stat-info">
                                    {% set students = [] %}{% for message in messages %}{% if message.student and message.student not in students %}{% set students = students|merge([message.student]) %}{% endif %}{% endfor %}
                                    <span class="stat-number">{{ students|length }}</span>
                                    <span class="stat-label">Étudiant{{ students|length > 1 ? 's' : '' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informations du cours -->
                    <div class="course-info-card">
                        <h4>Informations du cours</h4>
                        <div class="course-summary">
                            <h5>{{ course.titre }}</h5>
                            {% if course.category %}
                                <p class="text-muted">
                                    <i class="fa fa-tag"></i> {{ course.category }}
                                </p>
                            {% endif %}
                            {% if course.price %}
                                <p class="text-success">
                                    <i class="fa fa-euro"></i> {{ course.price }}
                                </p>
                            {% else %}
                                <p class="text-primary">
                                    <i class="fa fa-gift"></i> Gratuit
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.filter-card,
.discussions-card,
.actions-card,
.stats-card,
.course-info-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.discussion-item {
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.discussion-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.discussion-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.discussion-info h5 {
    margin-bottom: 5px;
    color: #333;
}

.discussion-content {
    margin-bottom: 15px;
}

.discussion-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.meta-info {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.last-message {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    border-left: 3px solid #007bff;
}

.stats-list {
    list-style: none;
    padding: 0;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-item i {
    width: 30px;
    height: 30px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-info {
    display: flex;
    flex-direction: column;
}

.stat-number {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
}

.course-summary h5 {
    color: #333;
    margin-bottom: 10px;
}

.course-summary p {
    margin-bottom: 5px;
}

.action-buttons .btn {
    margin-bottom: 10px;
}

/* Styles pour les formulaires de recherche et de message */
.conversation-search {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
}

.message-form {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    color: #333;
}

.form-control {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px 15px;
    font-size: 14px;
    transition: border-color 0.3s ease;
    width: 100%;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: 0;
}

.form-actions {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.form-actions .btn {
    flex: 1;
    min-width: 120px;
}

/* Responsive */
@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        min-width: auto;
    }
}

/* Styles pour le formulaire de réponse étudiant */
.student-reply-form {
    background: #e8f5e8;
    border: 1px solid #28a745;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.reply-header h6 {
    color: #28a745;
    margin-bottom: 10px;
    font-weight: 600;
}

.reply-form .form-group {
    margin-bottom: 15px;
}

.reply-form .form-control {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 8px 12px;
    font-size: 13px;
    resize: vertical;
}

.reply-form .form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40,167,69,0.25);
    outline: 0;
}

.reply-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}

.reply-actions .btn-sm {
    font-size: 12px;
    padding: 6px 12px;
}

.reply-actions small {
    font-size: 11px;
    opacity: 0.8;
}

.no-discussions {
    text-align: center;
    padding: 40px 20px;
}

/* Styles pour les bulles de discussion */
.discussion-thread {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
}

.message-bubble {
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 12px;
    position: relative;
}

.message-bubble.student-message {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    margin-left: 20px;
    margin-right: 60px;
}

.message-bubble.teacher-message {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
    margin-right: 20px;
    margin-left: 60px;
}

.message-header {
    margin-bottom: 10px;
}

.message-sender {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 0.9rem;
}

.message-date {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-left: auto;
}

.message-content p {
    margin-bottom: 0;
    line-height: 1.5;
}

.more-messages-indicator {
    padding: 10px;
    margin: 10px 0;
    border-top: 1px dashed #dee2e6;
    border-bottom: 1px dashed #dee2e6;
}

/* Responsive */
@media (max-width: 768px) {
    .message-bubble.student-message,
    .message-bubble.teacher-message {
        margin-left: 10px;
        margin-right: 10px;
    }
    
    .message-sender {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .message-date {
        margin-left: 0;
        margin-top: 5px;
    }
}

.badge-success { background-color: #28a745; color: white; }
.badge-warning { background-color: #ffc107; color: white; }
.badge-danger { background-color: #dc3545; color: white; }
.badge-info { background-color: #17a2b8; color: white; }
.badge-primary { background-color: #007bff; color: white; }

.ml-3 {
    margin-left: 15px;
}

.text-muted {
    color: #6c757d !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des statistiques
    const statNumbers = document.querySelectorAll('.stat-number');
    
    statNumbers.forEach(stat => {
        const target = parseInt(stat.textContent) || 0;
        stat.textContent = '0';
        
        const increment = target / 50;
        let current = 0;
        
        const updateCounter = () => {
            if (current < target) {
                current += increment;
                stat.textContent = Math.ceil(current);
                setTimeout(updateCounter, 30);
            } else {
                stat.textContent = target;
            }
        };
        
        // Observer l'intersection pour déclencher l'animation
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    updateCounter();
                    observer.unobserve(entry.target);
                }
            });
        });
        
        observer.observe(stat);
    });
});
</script>
{% endblock %}
