{% extends 'front/base.html.twig' %}

{% block title %}Passer le quiz: {{ quiz.titre }}{% endblock %}

{% block body %}
<!-- Page Title -->
<div class="page-banner ovbl-dark" style="background-image:url({{ asset('front-assets/images/banner/quiz-banner.jpg') }});">
    <div class="container">
        <div class="page-banner-entry">
            <h1 class="text-white">{{ quiz.titre }}</h1>
            <p class="text-white m-b0">Quiz en cours</p>
        </div>
    </div>
</div>

<!-- Breadcrumb -->
<div class="breadcrumb-row">
    <div class="container">
        <ul class="list-inline">
            <li><a href="{{ path('front_home') }}">Accueil</a></li>
            <li><a href="{{ path('quiz_index') }}">Quiz</a></li>
            <li>{{ quiz.titre }}</li>
        </ul>
    </div>
</div>

<!-- Content -->
<div class="content-block">
    <div class="section-area section-sp2">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="cours-bx">
                        <div class="cours-info">
                            <!-- Timer Header -->
                            <div class="quiz-header mb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-1">{{ quiz.titre }}</h3>
                                        <p class="text-muted mb-0">{{ quiz.description }}</p>
                                    </div>
                                    <div class="timer text-center">
                                        <div class="timer-display" id="timer">
                                            <i class="fa fa-clock-o"></i>
                                            <span id="time">{{ quiz.duree * 60 }}</span>
                                        </div>
                                        <small class="text-muted">Temps restant</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quiz Info -->
                            <div class="quiz-info-bar mb-4">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <i class="fa fa-question-circle"></i>
                                            <span>{{ quiz.questions|length }}</span>
                                            <small>Questions</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <i class="fa fa-clock"></i>
                                            <span>{{ quiz.duree ?: 30 }}</span>
                                            <small>Minutes</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <i class="fa fa-star"></i>
                                            <span>{{ quiz.pointsTotal ?? quiz.questions|length * 10 }}</span>
                                            <small>Points</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <i class="fa fa-check-circle"></i>
                                            <span>Multiple</span>
                                            <small>Réponses</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quiz Form -->
                            <form method="post" id="quizForm" class="quiz-form" action="{{ path('quiz_submit', {'id': quiz.idquiz}) }}">
                                <input type="hidden" name="duree_effective" id="duree_effective" value="0">
                                <input type="hidden" name="quiz_id" value="{{ quiz.idquiz }}">
                                
                                {% for question in quiz.questions %}
                                    <div class="question-container mb-4 p-4 border rounded" data-question-id="{{ question.id }}">
                                        <div class="question-header mb-3">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h5 class="question-title">
                                                        <span class="question-number">{{ loop.index }}.</span>
                                                        {{ question.texte }}
                                                    </h5>
                                                    {% if question.points %}
                                                        <span class="badge bg-info">{{ question.points }} points</span>
                                                    {% endif %}
                                                </div>
                                                <div class="question-progress">
                                                    <small class="text-muted">Question {{ loop.index }}/{{ quiz.questions|length }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="answers-container">
                                            {% if question.answers|length > 0 %}
                                                {% for answer in question.answers %}
                                                    <div class="answer-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input answer-checkbox" 
                                                                   type="checkbox" 
                                                                   name="answers[{{ question.id }}][]" 
                                                                   value="{{ answer.id }}" 
                                                                   id="answer_{{ answer.id }}"
                                                                   data-question="{{ question.id }}">
                                                            <label class="form-check-label" for="answer_{{ answer.id }}">
                                                                <span class="answer-text">{{ answer.texte }}</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="alert alert-warning">
                                                    <i class="fa fa-exclamation-triangle"></i>
                                                    Cette question n'a pas de réponses disponibles.
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Validation Message -->
                                        <div class="validation-message" id="validation_{{ question.id }}" style="display: none;">
                                            <div class="alert alert-danger mt-2">
                                                <i class="fa fa-exclamation-circle"></i>
                                                Veuillez sélectionner au moins une réponse pour cette question.
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                                
                                <!-- Submit Section -->
                                <div class="submit-section mt-5">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="progress-info mb-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Progression</span>
                                                    <span id="progress-text">0/{{ quiz.questions|length }}</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                                <i class="fa fa-paper-plane"></i>
                                                Soumettre le quiz
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Warning Modal -->
<div class="modal fade" id="warningModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">⚠️ Attention</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Vous avez des questions sans réponse. Êtes-vous sûr de vouloir soumettre le quiz ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="forceSubmit">Soumettre quand même</button>
            </div>
        </div>
    </div>
</div>

<style>
.quiz-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.timer-display {
    font-size: 1.5em;
    font-weight: bold;
    color: #fff;
}

.timer-display i {
    margin-right: 5px;
}

.quiz-info-bar {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.info-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.info-item i {
    font-size: 1.5em;
    color: #667eea;
    margin-bottom: 5px;
}

.info-item span {
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
}

.info-item small {
    color: #666;
    margin-top: 2px;
}

.question-container {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.question-container:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #667eea;
}

.question-title {
    color: #333;
    margin-bottom: 10px;
}

.question-number {
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 15px;
    font-size: 0.8em;
    margin-right: 8px;
}

.answer-item {
    margin-bottom: 10px;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-label {
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 5px;
    transition: background-color 0.2s ease;
}

.form-check-label:hover {
    background-color: #f8f9fa;
}

.answer-text {
    font-weight: 500;
}

.submit-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

.progress-bar {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 12px 30px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

@media (max-width: 768px) {
    .quiz-header {
        text-align: center;
    }
    
    .timer {
        margin-top: 15px;
    }
    
    .info-item {
        margin-bottom: 10px;
    }
}
</style>

<script>
let timeLeft = {{ quiz.duree ? (quiz.duree * 60) : 1800 }}; // 30 minutes par défaut si non spécifié
let timerElement = document.getElementById('time');
let dureeEffectiveElement = document.getElementById('duree_effective');
let startTime = Date.now();
let totalQuestions = {{ quiz.questions|length }};

function updateTimer() {
    timeLeft--;
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Update effective duration
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    dureeEffectiveElement.value = elapsed;
    
    // Change color when time is running out
    if (timeLeft <= 60) {
        timerElement.style.color = '#dc3545';
        document.querySelector('.timer-display').style.background = 'rgba(220, 53, 69, 0.1)';
        document.querySelector('.timer-display').style.padding = '5px 10px';
        document.querySelector('.timer-display').style.borderRadius = '5px';
    }
    
    if (timeLeft <= 0) {
        clearInterval(timerInterval);
        // Submit form via AJAX
        submitQuizAjax();
    }
}

// Update progress
function updateProgress() {
    const answeredQuestions = document.querySelectorAll('.answer-checkbox:checked').length;
    const uniqueQuestions = new Set();
    
    document.querySelectorAll('.answer-checkbox:checked').forEach(checkbox => {
        uniqueQuestions.add(checkbox.dataset.question);
    });
    
    const progress = (uniqueQuestions.size / totalQuestions) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('progress-text').textContent = `${uniqueQuestions.size}/${totalQuestions}`;
    
    return uniqueQuestions.size;
}

// Form validation
document.getElementById('quizForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const answeredCount = updateProgress();
    
    if (answeredCount < totalQuestions) {
        // Show warning modal
        const modal = new bootstrap.Modal(document.getElementById('warningModal'));
        modal.show();
    } else {
        submitQuizAjax();
    }
});

// Handle force submit button click (set once)
document.getElementById('forceSubmit').addEventListener('click', function() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
    if (modal) {
        modal.hide();
    }
    submitQuizAjax();
});

// Function to submit quiz via AJAX
function submitQuizAjax() {
    const form = document.getElementById('quizForm');
    const formData = new FormData(form);
    
    // Stop timer
    clearInterval(timerInterval);
    
    // Show loading state
    const quizContainer = document.querySelector('.cours-bx');
    quizContainer.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <h4 class="mt-3">Calcul de vos résultats...</h4>
        </div>
    `;
    
    // Submit via AJAX
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        // Replace the entire quiz content with results
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Try to find the results container
        const resultsContainer = tempDiv.querySelector('.results-container') || 
                                tempDiv.querySelector('.content-block') || 
                                tempDiv.querySelector('main') ||
                                tempDiv.querySelector('body');
        
        if (resultsContainer) {
            // Replace the quiz container with results
            const quizContainer = document.querySelector('.cours-bx');
            if (quizContainer) {
                quizContainer.innerHTML = resultsContainer.innerHTML;
                quizContainer.className = resultsContainer.className;
            } else {
                // Fallback: replace main content area
                const mainContent = document.querySelector('main') || document.querySelector('.content-block') || document.body;
                mainContent.innerHTML = resultsContainer.innerHTML;
            }
        } else {
            // Fallback: replace entire content
            document.body.innerHTML = html;
        }
        
        // Update page title
        document.title = 'Résultats - Quiz';
        
        // Scroll to top
        window.scrollTo(0, 0);
        
        // Reinitialize any scripts that might be needed
        if (typeof Chart !== 'undefined') {
            // Chart.js will be initialized by the results template
        }
    })
    .catch(error => {
        console.error('Error:', error);
        quizContainer.innerHTML = `
            <div class="alert alert-danger text-center py-5">
                <h4>Erreur lors de la soumission</h4>
                <p>Veuillez réessayer.</p>
                <button onclick="location.reload()" class="btn btn-primary">Réessayer</button>
            </div>
        `;
    });
}

// Update progress when answers change
document.querySelectorAll('.answer-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateProgress);
});

// Timer
const timerInterval = setInterval(updateTimer, 1000);

// Auto-save progress every 30 seconds
setInterval(function() {
    const answeredCount = updateProgress();
    console.log('Progress saved: ' + answeredCount + '/' + totalQuestions);
}, 30000);

// Prevent accidental page leave (only if there are unsaved changes and timer is still running)
window.addEventListener('beforeunload', function(e) {
    // Don't show warning if timer is at 0 or less (quiz is finished)
    if (timeLeft <= 0) {
        return;
    }
    
    // Don't show warning if no answers are selected
    const answeredCount = document.querySelectorAll('.answer-checkbox:checked').length;
    if (answeredCount === 0) {
        return;
    }
    
    // Show warning if there are answers and timer is still running
    e.preventDefault();
    e.returnValue = '';
});

</script>
{% endblock %}
